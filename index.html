<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manikshan Boat Report System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <style>
    /* CHANGED: Accent color is now BLUE */
    :root{--accent:#0056b3; --accent-hover:#004494; --muted:#666; --card:#fff; --danger:#dc3545; --success:#28a745; --bg:#f4f7f6; --border:#dee2e6;}
    body{font-family:'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height:1.5; background:var(--bg); color:#333; margin:0; padding:20px}
    
    /* Header */
    header{display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #e9ecef;}
    h1{font-size:1.5rem; margin:0; color:var(--accent); font-weight:700; display:flex; align-items:center; gap:10px;}
    
    /* Layout */
    .container{display:grid; grid-template-columns:1fr; gap:20px; max-width:1400px; margin:0 auto;}
    .card{background:var(--card); padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); border:1px solid #e9ecef;}
    
    /* Inputs & Controls */
    label{display:block; font-size:0.85rem; color:var(--muted); margin-bottom:5px; font-weight:600;}
    input[type="text"],input[type="number"],input[type="date"],select,textarea{
      width:100%; padding:10px; border-radius:4px; border:1px solid var(--border); font-size:0.95rem; background:#fff; transition:border-color 0.2s; box-sizing: border-box;
    }
    input:focus, textarea:focus{border-color:var(--accent); outline:none; box-shadow:0 0 0 3px rgba(0,86,179,0.1);}
    
    .row{display:flex; gap:15px; align-items:flex-end;}
    .row > *{flex:1}
    .controls{display:flex; gap:10px; align-items:center}
    
    /* Buttons - BLUE Theme */
    button{background:var(--accent); color:#fff; padding:10px 16px; border:none; border-radius:4px; cursor:pointer; font-weight:600; font-size:0.9rem; transition:background 0.2s;}
    button:hover{background:var(--accent-hover);}
    button.secondary{background:#e9ecef; color:#495057;}
    button.secondary:hover{background:#dee2e6;}
    button.danger{background:#fff; color:var(--danger); border:1px solid var(--danger); padding:6px 10px; font-size:0.8rem;}
    button.danger:hover{background:#fff5f5;}
    button.small{padding:6px 12px; font-size:0.85rem;}
    button.large-export{width:100%; margin-top:15px; background:#003d80; padding:15px; font-size:1rem; text-transform:uppercase; letter-spacing:0.5px;}

    /* Tables */
    table{width:100%; border-collapse:collapse; margin-top:12px; margin-bottom:12px;}
    th,td{padding:12px; border-bottom:1px solid #f1f1f1; text-align:left; font-size:0.9rem;}
    th{background:#f8f9fa; color:#495057; font-weight:600; font-size:0.85rem; text-transform:uppercase;}
    td input{border:1px solid transparent; background:transparent; padding:6px;}
    td input:hover, td input:focus{border:1px solid var(--border); background:#fff;}
    
    /* Typography & Sections */
    .section-title{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; color:var(--accent); border-bottom:2px solid #f1f1f1; padding-bottom:5px;}
    .section-title strong {font-size: 1.1rem;}
    .totals{font-weight:700; font-size:1rem; padding:10px 0; border-top:2px solid #f1f1f1; color:#333;}
    .muted{color:var(--muted); font-size:0.9rem}
    .green{color:var(--success); font-weight:700}
    .red{color:var(--danger); font-weight:700}
    
    hr{border:0; border-top:1px solid #eee; margin:25px 0;}
    .flex-between{display:flex; justify-content:space-between; align-items:center}
    .crew-list{display:grid; gap:10px}
    textarea{min-height:100px; resize:vertical; font-family:inherit;}
    
    /* Summary Box */
    .summary-box {
        background: #e3f2fd; /* Light Blue */
        border: 1px solid #bbdefb;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .summary-line { margin-bottom: 6px; display:flex; justify-content:space-between; font-size:0.95rem; }

    /* Responsive */
    @media(min-width:900px){
      .container{grid-template-columns:1.4fr 1fr}
    }

    /* PDF Print Area */
    #printArea { display: none; }
  </style>
</head>
<body>

  <header>
    <h1>Manikshan Boat Report System</h1>
    <div class="controls">
      <button id="saveLocal" class="small">Save Changes</button>
      <button id="clearAll" class="small secondary">Reset / Clear</button>
    </div>
  </header>

  <main class="container">
    
    <!-- Left Column: Inputs -->
    <section class="card">
      <div class="row" style="margin-bottom:15px;">
        <div style="flex:2">
          <label>Boat Name</label>
          <input id="boatName" type="text" placeholder="e.g. THEEKSHANA 01" />
        </div>
        <div>
          <label>Arrival Date</label>
          <input id="arrivalDate" type="date" />
        </div>
      </div>
      <div class="muted" id="arrivalInfo" style="margin-bottom:15px; font-style:italic; font-size:0.85rem;"></div>

      <hr>

      <!-- Departure -->
      <div>
        <div class="section-title"><strong>Boat Loaded Cost (Departure)</strong><button id="addDeparture" class="small">+ Add Item</button></div>
        <table id="departureTable"><thead><tr><th style="width:55%">Description</th><th>Amount (LKR)</th><th style="width:50px"></th></tr></thead><tbody></tbody></table>
        <div class="flex-between totals">Total: <div id="departureTotal">0.00</div></div>
      </div>

      <hr>

      <!-- Extra Expenses -->
      <div>
        <div class="section-title"><strong>Extra Expenses</strong><button id="addExtra" class="small">+ Add Item</button></div>
        <table id="extraTable"><thead><tr><th style="width:55%">Description</th><th>Amount (LKR)</th><th style="width:50px"></th></tr></thead><tbody></tbody></table>
        <div class="flex-between totals">Total: <div id="extraTotal">0.00</div></div>
      </div>

      <hr>

      <!-- Fuel -->
      <div>
        <div class="section-title"><strong>Fuel Consumption</strong></div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Price per Liter (LKR)</label>
            <input id="pricePerL" type="number" step="0.01" value="277" />
          </div>
          <div>
            <label>Liters Consumed</label>
            <input id="liters" type="number" step="0.01" value="0" />
          </div>
          <div style="width:140px">
            <label>Date</label>
            <input id="fuelDate" type="date" />
          </div>
        </div>
        <div class="flex-between totals" style="margin-top:10px">Total Fuel Cost: <div id="fuelTotal">0.00</div></div>
      </div>

      <hr>

      <!-- Boat Repairs -->
      <div>
        <div class="section-title"><strong>Boat Value & Repairs</strong></div>
        <div style="margin-bottom:15px">
          <label>Current Boat Value (LKR)</label>
          <input id="currentBoatValue" type="number" step="0.01" value="10000000" />
        </div>
        
        <div class="section-title"><strong>Repairs List</strong><button id="addBoatRep" class="small">+ Add Repair</button></div>
        <table id="boatRepTable"><thead><tr><th style="width:55%">Description</th><th>Amount (LKR)</th><th style="width:50px"></th></tr></thead><tbody></tbody></table>
        <div class="flex-between totals">Repairs Total: <div id="boatRepTotal">0.00</div></div>
      </div>

      <hr>

      <!-- Loans Settled -->
      <div>
        <div class="section-title"><strong>Loans Settled</strong><button id="addLoanSettled" class="small">+ Add Settled</button></div>
        <div class="muted" style="margin-bottom:5px">Deducted from profit to pay back loans.</div>
        <table id="loanSettledTable"><thead><tr><th style="width:55%">Description</th><th>Amount (LKR)</th><th style="width:50px"></th></tr></thead><tbody></tbody></table>
        <div class="flex-between totals">Total Settled: <div id="loanSettledTotal">0.00</div></div>
      </div>

      <hr>
      
      <!-- Pending Loans -->
      <div>
        <div class="section-title"><strong>Pending Loans</strong><button id="addPendingLoan" class="small">+ Add Pending</button></div>
        <div class="muted" style="margin-bottom:5px">Outstanding loans (for record keeping).</div>
        <table id="pendingLoansTable"><thead><tr><th style="width:55%">Description</th><th>Amount (LKR)</th><th style="width:50px"></th></tr></thead><tbody></tbody></table>
        <div class="flex-between totals">Total Pending: <div id="pendingLoansTotal">0.00</div></div>
      </div>

      <hr>

      <!-- Salaries -->
      <div>
        <div class="section-title"><strong>Salaries / Wages Paid</strong><button id="addSalary" class="small">+ Add Salary</button></div>
        <table id="salaryTable"><thead><tr><th style="width:55%">Name / Description</th><th>Amount (LKR)</th><th style="width:50px"></th></tr></thead><tbody></tbody></table>
        <div class="flex-between totals">Total Salaries: <div id="salaryTotal">0.00</div></div>
      </div>

    </section>

    <!-- Right Column: Summary & Sales -->
    <aside class="card">
      <!-- Fish Sales -->
      <div>
        <div class="section-title"><strong>Fish Sales</strong><button id="addFish" class="small">+ Add Catch</button></div>
        <table id="fishTable"><thead><tr><th>Category</th><th>Kg</th><th>Price</th><th>Total (LKR)</th><th style="width:30px"></th></tr></thead><tbody></tbody></table>
        <div class="flex-between totals" style="font-size:1.1rem; color:var(--accent);">Net Sales: <div id="netSales">0.00</div></div>
      </div>

      <hr>

      <!-- Profit Calculation -->
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #e9ecef;">
        <h3 style="margin-top:0; color:var(--accent); font-size:1.2rem; border-bottom:1px solid #dee2e6; padding-bottom:10px;">Profit & Expense</h3>
        
        <div class="flex-between muted"><div>Net Sales</div><div id="peNetSales">0.00</div></div>
        
        <div class="row" style="margin-top:10px; align-items:center">
          <label style="width:140px; margin:0">Market Comm. (%)</label>
          <input id="marketCommission" type="number" step="0.01" value="0" style="padding:5px" />
        </div>
        <div class="flex-between muted" style="margin-bottom:10px; font-size:0.85rem; border-bottom:1px dashed #ccc; padding-bottom:5px;">
            <i>Commission Value:</i> <span id="marketCommissionLKR">0.00</span>
        </div>

        <div class="muted" style="font-weight:600; margin-top:10px;">Deductions:</div>
        <div class="flex-between muted" style="padding-left:10px"><div>Loaded Costs</div><span id="deductibleDeparture">0.00</span></div>
        <div class="flex-between muted" style="padding-left:10px"><div>Extra Expenses</div><span id="deductibleExtra">0.00</span></div>
        <div class="flex-between muted" style="padding-left:10px"><div>Fuel Cost</div><span id="deductibleFuel">0.00</span></div>
        <div class="flex-between muted" style="padding-left:10px"><div>Repairs</div><span id="deductibleRepairs">0.00</span></div>

        <div class="flex-between totals" style="border-top:1px dashed #aaa; margin-top:5px; padding-top:5px">
            <div>Total Deductions</div><div id="totalDeductions">0.00</div>
        </div>
        
        <div class="flex-between totals" style="background:#e9ecef; padding:8px; border-radius:4px; margin:8px 0;">
            <div>Balance After Deductions</div><div id="balanceAfter">0.00</div>
        </div>

        <div class="row" style="margin-top:10px; align-items:center">
          <label style="width:140px; margin:0">Skipper Comm. (%)</label>
          <input id="skipperCommission" type="number" step="0.01" value="0" style="padding:5px" />
        </div>
        <div class="flex-between muted" style="margin-bottom:10px; font-size:0.85rem">
            <i>Commission Value:</i> <span id="skipperCommissionLKR">0.00</span>
        </div>
        
        <div class="flex-between totals" style="font-size:1.1rem; color:#333">
            <div>Final Balance</div><div id="finalBalance">0.00</div>
        </div>

        <div class="flex-between totals" style="margin-top:15px; font-size:1.2rem; border-bottom:2px solid #dee2e6; padding-bottom:10px">
            <div>Owner's Profit (50%)</div><div id="ownersProfit" class="green">0.00</div>
        </div>
        
        <div class="flex-between" style="margin-top:5px; font-weight:600;">
            <div>Status</div><div id="profitLoss">Profit</div>
        </div>

        <div style="background:#d1e7dd; padding:12px; border-radius:6px; margin-top:15px; border:1px solid #badbcc">
            <div class="muted" style="font-size:0.8rem; color:#0f5132;">Bank Deposited = Owner Profit + Loans Settled - Salaries</div>
            <div class="flex-between totals" style="color:#0f5132; font-size:1.2rem; border:0">
                <div>Bank Deposited</div><div id="bankDeposited">0.00</div>
            </div>
        </div>

      </div>

      <hr>

      <!-- Crew -->
      <div>
        <div class="section-title"><strong>Crew Distribution (50%)</strong><button id="addCrew" class="small">+ Add Crew</button></div>
        <div class="flex-between totals" style="margin-bottom:10px"><div>Total Crew Pool</div><div id="crewPool">0.00</div></div>
        <div class="crew-list" id="crewList"></div>
      </div>

      <hr>

      <!-- Notes -->
      <div>
        <label>Notes / Remarks</label>
        <textarea id="notes" placeholder="Add comments here..."></textarea>
      </div>
      
      <!-- NEW: Final Summary Interface -->
      <div class="summary-box">
          <h4 style="margin-top:0; color:var(--accent); margin-bottom:10px; border-bottom:1px solid #bbdefb; padding-bottom:5px;">Trip Summary & Statistics</h4>
          <div id="finalSummaryContent" style="font-size:0.9rem; color:#444;">
              <!-- Javascript will populate this -->
          </div>
      </div>

      <button id="exportPdf" class="large-export">Download Professional PDF</button>

    </aside>
  </main>

  <!-- Hidden Print Template (Table-Wise Layout) -->
  <div id="printArea">
    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #333; width: 210mm; padding: 10mm; box-sizing:border-box;">
      
      <!-- Header -->
      <div style="border-bottom:3px solid #0056b3; padding-bottom:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:flex-end;">
        <div>
          <h1 style="color:#0056b3; margin:0; font-size:26px;">Manikshan Boat Report</h1>
          <p style="margin:5px 0 0 0; font-size:14px; color:#666;">Official Trip Statement</p>
        </div>
        <div style="text-align:right;">
          <h2 style="margin:0; font-size:20px; color:#333;" id="pdfBoatName"></h2>
          <p style="margin:5px 0 0 0; font-size:14px; color:#555;" id="pdfDate"></p>
        </div>
      </div>

      <!-- Top Section: Sales & Financial Summary -->
      <div style="margin-bottom:20px;">
          <h3 style="background:#0056b3; color:#fff; padding:6px 10px; margin:0; font-size:14px; text-transform:uppercase;">1. Income & Summary</h3>
          <table style="width:100%; border-collapse:collapse; font-size:12px; margin-top:10px;">
              <tr>
                  <!-- Fish Sales Table -->
                  <td style="vertical-align:top; width:60%; padding-right:20px;">
                      <table id="pdfFish" style="width:100%; border-collapse:collapse; border:1px solid #ccc;">
                          <thead style="background:#f2f2f2;"><tr><th style="border:1px solid #ccc; padding:6px; text-align:left;">Category</th><th style="border:1px solid #ccc; padding:6px; text-align:right;">Kg</th><th style="border:1px solid #ccc; padding:6px; text-align:right;">Total</th></tr></thead>
                          <tbody></tbody>
                          <tfoot><tr><td colspan="2" style="border:1px solid #ccc; padding:6px; font-weight:bold; text-align:right;">Total Sales</td><td style="border:1px solid #ccc; padding:6px; font-weight:bold; text-align:right;" id="pdfNetSales"></td></tr></tfoot>
                      </table>
                  </td>
                  <!-- Financial Box Table -->
                  <td style="vertical-align:top; width:40%;">
                      <table style="width:100%; border-collapse:collapse; border:2px solid #0056b3;">
                          <tr><td style="padding:8px; border-bottom:1px solid #eee;">Net Sales</td><td style="padding:8px; text-align:right; border-bottom:1px solid #eee; font-weight:bold;" id="pdfSumSales"></td></tr>
                          <tr><td style="padding:8px; border-bottom:1px solid #eee; color:#dc3545;">Less: Total Deductions</td><td style="padding:8px; text-align:right; border-bottom:1px solid #eee; color:#dc3545;" id="pdfSumDed"></td></tr>
                          <tr style="background:#e3f2fd;"><td style="padding:8px; border-bottom:1px solid #eee; font-weight:bold;">Final Balance</td><td style="padding:8px; text-align:right; border-bottom:1px solid #eee; font-weight:bold;" id="pdfSumBal"></td></tr>
                          <tr><td style="padding:8px; border-bottom:1px solid #eee;">Owner's Profit (50%)</td><td style="padding:8px; text-align:right; border-bottom:1px solid #eee; font-weight:bold; color:#28a745;" id="pdfOwner"></td></tr>
                          <tr><td style="padding:8px; border-bottom:1px solid #eee;">Crew Pool (50%)</td><td style="padding:8px; text-align:right; border-bottom:1px solid #eee; font-weight:bold;" id="pdfCrewPool"></td></tr>
                          <tr style="background:#0056b3; color:#fff;"><td style="padding:10px; font-weight:bold;">BANK DEPOSITED</td><td style="padding:10px; text-align:right; font-weight:bold; font-size:14px;" id="pdfBank"></td></tr>
                      </table>
                  </td>
              </tr>
          </table>
      </div>

      <!-- Middle Section: Expenses Tables -->
      <div style="margin-bottom:20px;">
          <h3 style="background:#0056b3; color:#fff; padding:6px 10px; margin:0; font-size:14px; text-transform:uppercase;">2. Expenses Breakdown</h3>
          <table style="width:100%; border-collapse:collapse; font-size:12px; margin-top:10px;">
              <tr>
                  <td style="vertical-align:top; width:33%; padding-right:10px;">
                      <h4 style="margin:0 0 5px 0; font-size:12px; text-align:center; background:#eee; padding:4px; border:1px solid #ccc;">Departure Costs</h4>
                      <table id="pdfDep" style="width:100%; border-collapse:collapse; border:1px solid #ccc;">
                          <tbody></tbody>
                      </table>
                  </td>
                  <td style="vertical-align:top; width:33%; padding-right:10px;">
                      <h4 style="margin:0 0 5px 0; font-size:12px; text-align:center; background:#eee; padding:4px; border:1px solid #ccc;">Extra Expenses</h4>
                      <table id="pdfExtra" style="width:100%; border-collapse:collapse; border:1px solid #ccc;">
                          <tbody></tbody>
                      </table>
                  </td>
                  <td style="vertical-align:top; width:33%;">
                      <h4 style="margin:0 0 5px 0; font-size:12px; text-align:center; background:#eee; padding:4px; border:1px solid #ccc;">Fuel & Comm.</h4>
                      <table style="width:100%; border-collapse:collapse; border:1px solid #ccc;">
                          <tr><td style="border:1px solid #ccc; padding:4px;">Fuel Cost</td><td style="border:1px solid #ccc; padding:4px; text-align:right;" id="pdfFuel"></td></tr>
                          <tr><td style="border:1px solid #ccc; padding:4px;">Market Comm.</td><td style="border:1px solid #ccc; padding:4px; text-align:right;" id="pdfMkt"></td></tr>
                          <tr><td style="border:1px solid #ccc; padding:4px;">Skipper Comm.</td><td style="border:1px solid #ccc; padding:4px; text-align:right;" id="pdfSkip"></td></tr>
                          <tr><td style="border:1px solid #ccc; padding:4px;">Repairs Total</td><td style="border:1px solid #ccc; padding:4px; text-align:right;" id="pdfRepTotal"></td></tr>
                      </table>
                      
                      <h4 style="margin:10px 0 5px 0; font-size:12px; text-align:center; background:#eee; padding:4px; border:1px solid #ccc;">Repairs List</h4>
                      <table id="pdfRep" style="width:100%; border-collapse:collapse; border:1px solid #ccc;">
                         <tbody></tbody>
                      </table>
                  </td>
              </tr>
          </table>
      </div>

      <!-- Bottom Section: Loans & Crew -->
      <div>
           <h3 style="background:#0056b3; color:#fff; padding:6px 10px; margin:0; font-size:14px; text-transform:uppercase;">3. Distributions & Loans</h3>
           <table style="width:100%; border-collapse:collapse; font-size:12px; margin-top:10px;">
               <tr>
                   <td style="vertical-align:top; width:50%; padding-right:15px;">
                       <!-- Crew Table -->
                       <table id="pdfCrew" style="width:100%; border-collapse:collapse; border:1px solid #ccc; margin-bottom:15px;">
                           <thead style="background:#f2f2f2;"><tr><th style="border:1px solid #ccc; padding:5px; text-align:left;">Crew Name</th><th style="border:1px solid #ccc; padding:5px; text-align:right;">Share</th></tr></thead>
                           <tbody></tbody>
                       </table>
                       
                       <!-- Salaries -->
                       <div style="border:1px solid #ccc; padding:0;">
                           <div style="background:#eee; padding:4px; font-weight:bold; text-align:center; border-bottom:1px solid #ccc;">Salaries Paid</div>
                           <table id="pdfSal" style="width:100%; border-collapse:collapse;"><tbody></tbody></table>
                       </div>
                   </td>
                   <td style="vertical-align:top; width:50%;">
                       <!-- Loans Settled -->
                       <div style="border:1px solid #ccc; margin-bottom:10px;">
                           <div style="background:#d1e7dd; padding:4px; font-weight:bold; text-align:center; border-bottom:1px solid #ccc; color:#0f5132;">Loans Settled (Paid)</div>
                           <table id="pdfLoans" style="width:100%; border-collapse:collapse;"><tbody></tbody></table>
                       </div>
                       
                       <!-- Pending Loans -->
                       <div style="border:1px solid #ccc;">
                           <div style="background:#f8d7da; padding:4px; font-weight:bold; text-align:center; border-bottom:1px solid #ccc; color:#842029;">Pending Loans (Outstanding)</div>
                           <table id="pdfPending" style="width:100%; border-collapse:collapse;"><tbody></tbody></table>
                       </div>
                   </td>
               </tr>
           </table>
      </div>

      <!-- Footer Notes & Signatures -->
      <div style="margin-top:20px; border:1px solid #ccc; padding:10px; font-size:12px; background:#fcfcfc;">
        <strong>Notes:</strong> <span id="pdfNotes"></span>
      </div>
      
      <div style="margin-top:40px; display:flex; justify-content:space-between; font-size:12px;">
        <div style="text-align:center; width:150px;">
            <div style="border-bottom:1px solid #000; margin-bottom:5px; height:30px;"></div>
            Owner Signature
        </div>
        <div style="text-align:center; width:150px;">
            <div style="border-bottom:1px solid #000; margin-bottom:5px; height:30px;"></div>
            Skipper Signature
        </div>
      </div>

    </div>
  </div>

  <!-- Logic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script>
    // Utilities
    const $ = sel => document.querySelector(sel);
    const fmt = v => parseFloat(v || 0).toLocaleString('en-LK', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const orNum = v => Number(v) || 0;

    // Elements
    const boatName = $('#boatName');
    const arrivalDate = $('#arrivalDate');
    const arrivalInfo = $('#arrivalInfo');

    const departureTable = $('#departureTable tbody');
    const extraTable = $('#extraTable tbody');
    const boatRepTable = $('#boatRepTable tbody');
    const loanSettledTable = $('#loanSettledTable tbody');
    const pendingLoansTable = $('#pendingLoansTable tbody');
    const salaryTable = $('#salaryTable tbody');
    const fishTable = $('#fishTable tbody');
    const crewList = $('#crewList');

    // Totals elements
    const departureTotalEl = $('#departureTotal');
    const extraTotalEl = $('#extraTotal');
    const fuelTotalEl = $('#fuelTotal');
    const boatRepTotalEl = $('#boatRepTotal');
    const loanSettledTotalEl = $('#loanSettledTotal');
    const pendingLoansTotalEl = $('#pendingLoansTotal');
    const salaryTotalEl = $('#salaryTotal');
    const netSalesEl = $('#netSales');

    const pricePerL = $('#pricePerL');
    const liters = $('#liters');
    const fuelDate = $('#fuelDate');

    const currentBoatValue = $('#currentBoatValue');

    const marketCommission = $('#marketCommission');
    const marketCommissionLKR = $('#marketCommissionLKR');
    const deductibleDeparture = $('#deductibleDeparture');
    const deductibleExtra = $('#deductibleExtra');
    const deductibleFuel = $('#deductibleFuel');
    const deductibleRepairs = $('#deductibleRepairs');
    const totalDeductionsEl = $('#totalDeductions');
    const balanceAfterEl = $('#balanceAfter');
    const peNetSales = $('#peNetSales');
    const skipperCommission = $('#skipperCommission');
    const skipperCommissionLKR = $('#skipperCommissionLKR');
    const finalBalanceEl = $('#finalBalance');
    const ownersProfitEl = $('#ownersProfit');
    const profitLossEl = $('#profitLoss');
    const bankDepositedEl = $('#bankDeposited');
    const crewPoolEl = $('#crewPool');
    const notesEl = $('#notes');
    const finalSummaryContent = $('#finalSummaryContent');

    // Buttons
    const addDeparture = $('#addDeparture');
    const addExtra = $('#addExtra');
    const addBoatRep = $('#addBoatRep');
    const addLoanSettled = $('#addLoanSettled');
    const addPendingLoan = $('#addPendingLoan');
    const addSalary = $('#addSalary');
    const addFish = $('#addFish');
    const addCrew = $('#addCrew');
    const saveLocal = $('#saveLocal');
    const exportPdf = $('#exportPdf');
    const clearAll = $('#clearAll');

    // Date defaults
    fuelDate.valueAsDate = new Date();

    // Helpers
    function createRow(tableBody, desc='', amt=0, placeholders={desc:'Description', amt:'0.00'}, onChange){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><input class='desc' type='text' value='${desc}' placeholder='${placeholders.desc}' /></td>
                      <td><input class='amt' type='number' step='0.01' value='${amt}' /></td>
                      <td><button class='delete danger'>X</button></td>`;
      tableBody.appendChild(tr);
      tr.querySelector('.amt').addEventListener('input', () => {onChange && onChange(); recalcAll();});
      tr.querySelector('.desc').addEventListener('input', () => saveState());
      tr.querySelector('.delete').addEventListener('click', ()=>{tr.remove(); recalcAll(); saveState();});
      return tr;
    }

    function createFishRow(cat='', kg=0, price=0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><input class='cat' type='text' value='${cat}' placeholder='Category' /></td>
                      <td><input class='kg' type='number' step='0.01' value='${kg}' /></td>
                      <td><input class='p' type='number' step='0.01' value='${price}' /></td>
                      <td class='rowTotal'>0.00</td>
                      <td><button class='delete danger'>X</button></td>`;
      fishTable.appendChild(tr);
      const inputs = tr.querySelectorAll('input');
      inputs.forEach(i=>i.addEventListener('input', ()=>{recalcAll(); saveState()}));
      tr.querySelector('.delete').addEventListener('click', ()=>{tr.remove(); recalcAll(); saveState();});
      return tr;
    }

    function createCrewRow(name='',share=0){
      const div = document.createElement('div');
      div.className = 'crew-row';
      div.innerHTML = `<div class='row' style='gap:8px; align-items:center; margin-bottom:5px;'>
                        <input class='crewName' placeholder='Crew name' value='${name}'/>
                        <input class='crewShare' type='number' step='0.01' value='${share}' />
                        <button class='delete danger'>X</button>
                       </div>`;
      crewList.appendChild(div);
      div.querySelector('.crewName').addEventListener('input', ()=>saveState());
      div.querySelector('.crewShare').addEventListener('input', ()=>{recalcAll(); saveState()});
      div.querySelector('.delete').addEventListener('click', ()=>{div.remove(); recalcAll(); saveState()});
      return div;
    }

    function addDefaultRows(){
      if(!departureTable.children.length) createRow(departureTable,'','0');
      if(!extraTable.children.length) createRow(extraTable,'','0');
      if(!boatRepTable.children.length) createRow(boatRepTable,'','0');
      if(!loanSettledTable.children.length) createRow(loanSettledTable,'','0');
      if(!pendingLoansTable.children.length) createRow(pendingLoansTable,'','0');
      if(!salaryTable.children.length) createRow(salaryTable,'','0');
      if(!fishTable.children.length) createFishRow('','0','0');
      if(!crewList.children.length) for(let i=0;i<5;i++) createCrewRow('Crew '+(i+1),0);
    }

    function recalcAll(){
      const depTotal = sumTable(departureTable,'amt');
      departureTotalEl.textContent = fmt(depTotal);

      const extraTotal = sumTable(extraTable,'amt');
      extraTotalEl.textContent = fmt(extraTotal);

      const boatRepTotal = sumTable(boatRepTable,'amt');
      boatRepTotalEl.textContent = fmt(boatRepTotal);

      const loanSettledTotal = sumTable(loanSettledTable,'amt');
      loanSettledTotalEl.textContent = fmt(loanSettledTotal);

      const pendingLoansTotal = sumTable(pendingLoansTable,'amt');
      pendingLoansTotalEl.textContent = fmt(pendingLoansTotal);

      const salaryTotal = sumTable(salaryTable,'amt');
      salaryTotalEl.textContent = fmt(salaryTotal);

      // Fuel
      const fuelCost = orNum(pricePerL.value) * orNum(liters.value);
      fuelTotalEl.textContent = fmt(fuelCost);
      deductibleFuel.textContent = fmt(fuelCost);

      // Sales
      let netSales = 0;
      Array.from(fishTable.children).forEach(tr=>{
        const kg = orNum(tr.querySelector('.kg').value);
        const p = orNum(tr.querySelector('.p').value);
        const t = kg * p;
        tr.querySelector('.rowTotal').textContent = fmt(t);
        netSales += t;
      });
      netSalesEl.textContent = fmt(netSales);
      peNetSales.textContent = fmt(netSales);

      // Commission & Deductions
      const mcpr = orNum(marketCommission.value);
      const mcLKR = netSales * mcpr/100;
      marketCommissionLKR.textContent = fmt(mcLKR);

      deductibleDeparture.textContent = fmt(depTotal);
      deductibleExtra.textContent = fmt(extraTotal);
      deductibleRepairs.textContent = fmt(boatRepTotal);

      const totalDeductions = depTotal + extraTotal + fuelCost + boatRepTotal + mcLKR;
      totalDeductionsEl.textContent = fmt(totalDeductions);

      const balanceAfter = netSales - totalDeductions;
      balanceAfterEl.textContent = fmt(balanceAfter);

      // Skipper Comm
      const skpr = orNum(skipperCommission.value);
      const skLKR = balanceAfter * skpr/100;
      skipperCommissionLKR.textContent = fmt(skLKR);

      const finalBalance = balanceAfter - skLKR;
      finalBalanceEl.textContent = fmt(finalBalance);

      const ownersProfit = finalBalance * 0.5;
      ownersProfitEl.textContent = fmt(ownersProfit);

      // Status
      if(ownersProfit>=0){ profitLossEl.textContent='Profit'; profitLossEl.classList.remove('red'); profitLossEl.classList.add('green'); }
      else { profitLossEl.textContent='Loss'; profitLossEl.classList.remove('green'); profitLossEl.classList.add('red'); }

      // Bank Deposited
      const bankDeposited = ownersProfit + loanSettledTotal - salaryTotal;
      bankDepositedEl.textContent = fmt(bankDeposited);

      // Crew Pool
      const crewPool = finalBalance - ownersProfit; 
      crewPoolEl.textContent = fmt(crewPool);

      // Crew distribution
      const crewRows = Array.from(crewList.querySelectorAll('.crew-row'));
      if(crewRows.length>0){
        const shares = crewRows.map(r=>orNum(r.querySelector('.crewShare').value));
        const allZero = shares.every(s=>s===0);
        if(allZero){
          const equal = crewPool / crewRows.length;
          crewRows.forEach(r=>{ r.querySelector('.crewShare').value = equal.toFixed(2); });
        } else {
          const sumShares = shares.reduce((a,b)=>a+b,0);
          if(sumShares>0){
            const factor = crewPool/sumShares;
            crewRows.forEach(r => {
              const cur = orNum(r.querySelector('.crewShare').value);
              r.querySelector('.crewShare').value = (cur * factor).toFixed(2);
            });
          }
        }
      }
      
      // Update Final Summary Interface
      updateSummaryInterface(netSales, totalDeductions, finalBalance, ownersProfit, bankDeposited, loanSettledTotal, pendingLoansTotal);

      saveState();
    }

    function updateSummaryInterface(sales, ded, bal, prof, bank, loans, pending){
        const bName = boatName.value || "Unknown Boat";
        const html = `
            <div class="summary-line"><strong>Boat Name:</strong> <span>${bName}</span></div>
            <div class="summary-line"><strong>Total Income (Sales):</strong> <span>${fmt(sales)}</span></div>
            <div class="summary-line"><strong>Total Expenses:</strong> <span style="color:var(--danger)">${fmt(ded)}</span></div>
            <hr style="margin:5px 0; border-color:#bbdefb;">
            <div class="summary-line"><strong>Net Balance:</strong> <span>${fmt(bal)}</span></div>
            <div class="summary-line"><strong>Owner Profit:</strong> <span style="color:var(--success)">${fmt(prof)}</span></div>
            <div class="summary-line"><strong>Settled Loans:</strong> <span>${fmt(loans)}</span></div>
            <div class="summary-line" style="font-size:1.1rem; margin-top:5px; font-weight:bold; color:#0056b3;">
                Bank Deposited: ${fmt(bank)}
            </div>
             <div class="summary-line" style="color:#888; font-size:0.8rem; margin-top:5px;">
                (Pending Loans: ${fmt(pending)})
            </div>
        `;
        finalSummaryContent.innerHTML = html;
    }

    function sumTable(tbody, selector){
      return Array.from(tbody.children).reduce((acc,tr)=>{
        const inp = tr.querySelector('.'+selector);
        return acc + orNum(inp?.value);
      },0);
    }

    // Events
    addDeparture.addEventListener('click', ()=>{createRow(departureTable,'','0',{},recalcAll);});
    addExtra.addEventListener('click', ()=>{createRow(extraTable,'','0',{},recalcAll);});
    addBoatRep.addEventListener('click', ()=>{createRow(boatRepTable,'','0',{},recalcAll);});
    addLoanSettled.addEventListener('click', ()=>{createRow(loanSettledTable,'','0',{},recalcAll);});
    addPendingLoan.addEventListener('click', ()=>{createRow(pendingLoansTable,'','0',{},recalcAll);});
    addSalary.addEventListener('click', ()=>{createRow(salaryTable,'','0',{},recalcAll);});
    addFish.addEventListener('click', ()=>{createFishRow('','0','0');});
    addCrew.addEventListener('click', ()=>{createCrewRow('Crew '+(crewList.children.length+1),0); recalcAll();});

    [pricePerL,liters,marketCommission,skipperCommission,currentBoatValue].forEach(el=>{ if(el) el.addEventListener('input', ()=>recalcAll()); });

    arrivalDate.addEventListener('change', ()=>{
      const a = arrivalDate.valueAsDate;
      if(!a){ arrivalInfo.textContent=''; return; }
      const today = new Date();
      const diff = Math.ceil((a - new Date(today.getFullYear(),today.getMonth(),today.getDate()))/(1000*60*60*24));
      if(diff>0) arrivalInfo.textContent = `${diff} day(s) until arrival`;
      else if(diff===0) arrivalInfo.textContent = `Arrival is today`;
      else arrivalInfo.textContent = `${Math.abs(diff)} day(s) since arrival`;
      saveState();
    });

    // Storage
    function saveState(){
      const state = {
        boatName: boatName.value,
        arrivalDate: arrivalDate.value,
        departure: serializeTable(departureTable),
        extra: serializeTable(extraTable),
        boatRep: serializeTable(boatRepTable),
        loanSettled: serializeTable(loanSettledTable),
        pendingLoans: serializeTable(pendingLoansTable),
        salary: serializeTable(salaryTable),
        fish: serializeFish(),
        pricePerL: pricePerL.value,
        liters: liters.value,
        fuelDate: fuelDate.value,
        currentBoatValue: currentBoatValue.value,
        marketCommission: marketCommission.value,
        skipperCommission: skipperCommission.value,
        notes: notesEl.value,
        crew: serializeCrew()
      };
      localStorage.setItem('manikshan_state', JSON.stringify(state));
    }

    function loadState(state){
      boatName.value = state.boatName || '';
      arrivalDate.value = state.arrivalDate || '';
      pricePerL.value = state.pricePerL || 277;
      liters.value = state.liters || 0;
      fuelDate.value = state.fuelDate || new Date().toISOString().slice(0,10);
      currentBoatValue.value = state.currentBoatValue || 10000000;
      marketCommission.value = state.marketCommission || 0;
      skipperCommission.value = state.skipperCommission || 0;
      notesEl.value = state.notes || '';

      populateTable(departureTable,state.departure);
      populateTable(extraTable,state.extra);
      populateTable(boatRepTable,state.boatRep);
      populateTable(loanSettledTable,state.loanSettled);
      populateTable(pendingLoansTable,state.pendingLoans);
      populateTable(salaryTable,state.salary);
      populateFish(state.fish);
      populateCrew(state.crew);

      if(arrivalDate.value) arrivalDate.dispatchEvent(new Event('change'));
      recalcAll();
    }

    function serializeTable(tbody){ return Array.from(tbody.children).map(tr=>({desc:tr.querySelector('.desc')?.value||'', amt:tr.querySelector('.amt')?.value||0})); }
    function populateTable(tbody,arr){ tbody.innerHTML=''; (arr||[]).forEach(r=>createRow(tbody,r.desc||'',r.amt||0,{},recalcAll)); }
    function serializeFish(){ return Array.from(fishTable.children).map(tr=>({cat:tr.querySelector('.cat').value, kg:tr.querySelector('.kg').value, p:tr.querySelector('.p').value})); }
    function populateFish(arr){ fishTable.innerHTML=''; (arr||[]).forEach(r=>createFishRow(r.cat||'',r.kg||0,r.p||0)); }
    function serializeCrew(){ return Array.from(crewList.querySelectorAll('.crew-row')).map(r=>({name:r.querySelector('.crewName').value,share:r.querySelector('.crewShare').value})); }
    function populateCrew(arr){ crewList.innerHTML=''; (arr||[]).forEach(c=>createCrewRow(c.name||'',c.share||0)); }

    saveLocal.addEventListener('click', ()=>{ saveState(); alert('Saved locally.'); });
    clearAll.addEventListener('click', ()=>{ if(confirm('Reset all data?')){ localStorage.removeItem('manikshan_state'); location.reload(); }});

    // --- PDF Generation Logic (Table-Wise) ---
    function populatePdfTable(srcTableId, targetId, isFish=false){
      const src = document.querySelector(srcTableId+' tbody');
      const tgt = document.getElementById(targetId).querySelector('tbody');
      tgt.innerHTML = '';
      const rows = Array.from(src.children);
      if(rows.length === 0){
          tgt.innerHTML = '<tr><td colspan="3" style="padding:4px; font-style:italic; color:#999;">No items</td></tr>';
          return;
      }
      rows.forEach(tr => {
        const row = document.createElement('tr');
        if(isFish){
           const cat = tr.querySelector('.cat').value || '-';
           const kg = tr.querySelector('.kg').value || '0';
           const tot = tr.querySelector('.rowTotal').textContent;
           row.innerHTML = `<td style="padding:4px; border:1px solid #ccc;">${cat}</td><td style="padding:4px; text-align:right; border:1px solid #ccc;">${kg}</td><td style="padding:4px; text-align:right; border:1px solid #ccc;">${tot}</td>`;
        } else {
           const desc = tr.querySelector('.desc').value || '-';
           const amt = fmt(tr.querySelector('.amt').value);
           row.innerHTML = `<td style="padding:4px; border:1px solid #ccc;">${desc}</td><td style="padding:4px; text-align:right; border:1px solid #ccc;">${amt}</td>`;
        }
        tgt.appendChild(row);
      });
    }
    
    function populatePdfCrew(){
      const tgt = document.getElementById('pdfCrew').querySelector('tbody');
      tgt.innerHTML = '';
      const rows = Array.from(crewList.querySelectorAll('.crew-row'));
       if(rows.length === 0){
          tgt.innerHTML = '<tr><td colspan="2" style="padding:4px; font-style:italic; color:#999;">No crew listed</td></tr>';
          return;
      }
      rows.forEach(r => {
        const name = r.querySelector('.crewName').value || '-';
        const share = fmt(r.querySelector('.crewShare').value);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="padding:5px; border:1px solid #ccc;">${name}</td><td style="padding:5px; text-align:right; border:1px solid #ccc;">${share}</td>`;
        tgt.appendChild(tr);
      });
    }

    exportPdf.addEventListener('click', ()=>{
      // 1. Fill Data
      $('#pdfBoatName').textContent = boatName.value;
      $('#pdfDate').textContent = arrivalDate.value ? 'Arrival: ' + arrivalDate.value : 'Date: ' + new Date().toLocaleDateString();
      
      populatePdfTable('#fishTable', 'pdfFish', true);
      populatePdfTable('#departureTable', 'pdfDep');
      populatePdfTable('#extraTable', 'pdfExtra');
      populatePdfTable('#boatRepTable', 'pdfRep');
      populatePdfTable('#loanSettledTable', 'pdfLoans');
      populatePdfTable('#pendingLoansTable', 'pdfPending');
      populatePdfTable('#salaryTable', 'pdfSal');
      populatePdfCrew();

      $('#pdfNetSales').textContent = netSalesEl.textContent;
      $('#pdfFuel').textContent = fuelTotalEl.textContent;
      $('#pdfMkt').textContent = marketCommissionLKR.textContent;
      $('#pdfSkip').textContent = skipperCommissionLKR.textContent;
      $('#pdfRepTotal').textContent = boatRepTotalEl.textContent;
      
      $('#pdfSumSales').textContent = netSalesEl.textContent;
      $('#pdfSumDed').textContent = totalDeductionsEl.textContent;
      $('#pdfSumBal').textContent = finalBalanceEl.textContent;
      
      $('#pdfOwner').textContent = ownersProfitEl.textContent;
      $('#pdfCrewPool').textContent = crewPoolEl.textContent;
      $('#pdfBank').textContent = bankDepositedEl.textContent;
      $('#pdfNotes').textContent = notesEl.value || 'None';

      // 2. Generate PDF
      const element = document.getElementById('printArea');
      element.style.display = 'block'; // Show temporarily
      const opt = {
        margin: 5,
        filename: `Report_${(boatName.value||'Boat')}_${new Date().toISOString().slice(0,10)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      
      html2pdf().set(opt).from(element).save().then(() => {
        element.style.display = 'none'; // Hide again
      });
    });

    // Init
    addDefaultRows();
    const saved = localStorage.getItem('manikshan_state');
    if(saved) loadState(JSON.parse(saved)); else recalcAll();

  </script>
</body>
</html>
