<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrival Report - Boat Financial System (LKR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f6f9; 
        }
        .section-card { 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        .total-box { 
            padding: 0.5rem 1rem; 
            font-weight: 700; 
            border-radius: 0.25rem;
        }
        
        /* --- PDF Template Styles --- */
        #pdf-template {
            width: 210mm; 
            margin: 0 auto;
            display: none; 
            padding: 20px;
            box-sizing: border-box;
            background-color: #ffffff; 
            font-family: 'Inter', sans-serif; 
            color: #000;
        }
        #pdf-template table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 11px; 
        }
        #pdf-template th, #pdf-template td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: left;
        }
        #pdf-template th {
            background-color: #f0f0f0;
            font-weight: 700;
            color: #333;
        }
        .pdf-header-strip { 
            background-color: #004b8d; 
            color: white; 
            padding: 8px; 
            font-weight: 700; 
            font-size: 14px; 
            margin-top: 10px;
        }
        .pdf-section-title {
            font-weight: 700;
            font-size: 13px;
            margin-top: 10px;
            margin-bottom: 4px;
            border-bottom: 1px solid #004b8d;
            color: #004b8d;
        }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .toggle-switch input { display: none; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(16px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6" id="report-container">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Arrival Report (LKR)</h1>

        <div class="flex flex-col space-y-4 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div class="flex space-x-3">
                    <button onclick="report.saveReport()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow">Save</button>
                    <button onclick="report.showClearModal()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow">Clear</button>
                </div>
                <span id="save-message" class="text-sm font-medium text-blue-600 pt-2 sm:pt-0"></span>
            </div>
        </div>

        <div id="interactive-content" class="space-y-6">

            <div class="section-card p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">Boat Name</label>
                    <input type="text" id="boat-name" oninput="report.updateboatName(this.value)" placeholder="Enter boat name" class="w-full rounded-lg border-gray-300 p-2 border">
                </div>
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">Arrival Date</label>
                    <input type="date" id="arrival-date" onchange="report.updateDate(this.value)" class="w-full rounded-lg border-gray-300 p-2 border">
                </div>
            </div>

            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">1. Boat Loaded Cost (Departure Expenses)</h2>
                <div id="boat-loaded-cost-entries"></div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                    <input type="text" id="blc-desc" placeholder="Description" class="p-2 border rounded-lg flex-grow">
                    <input type="number" id="blc-amount" placeholder="Amount" class="p-2 border rounded-lg w-full sm:w-32">
                    <button onclick="report.addEntry('boatLoadedCosts', 'blc-desc', 'blc-amount')" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add</button>
                </div>
                <div class="total-box mt-4 bg-blue-50 border-l-4 border-blue-500">Total Boat Loaded Cost: <span id="blc-total">0.00 LKR</span></div>
            </div>

            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Extra Expenses</h2>
                <div id="extra-expenses-entries"></div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                    <input type="text" id="ee-desc" placeholder="Description" class="p-2 border rounded-lg flex-grow">
                    <input type="number" id="ee-amount" placeholder="Amount" class="p-2 border rounded-lg w-full sm:w-32">
                    <button onclick="report.addEntry('extraExpenses', 'ee-desc', 'ee-amount')" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add</button>
                </div>
                <div class="total-box mt-4 bg-blue-50 border-l-4 border-blue-500">Total Extra Expenses: <span id="ee-total">0.00 LKR</span></div>
            </div>

            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">3. Fuel Consumption</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-600">Price per Liter (LKR)</label>
                        <input type="number" value="277.00" id="diesel-price" readonly class="w-full p-2 border bg-gray-100 rounded-lg">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Liters Consumed</label>
                        <input type="number" id="diesel-liters" oninput="report.calculateDiesel()" class="w-full p-2 border rounded-lg">
                    </div>
                </div>
                <div class="total-box mt-4 bg-blue-100 border-l-4 border-blue-600">Total Fuel Cost: <span id="diesel-cost-total">0.00 LKR</span></div>
            </div>

            <div class="section-card p-6 space-y-6">
                <h2 class="text-xl font-semibold text-gray-800">4. Boat Value & Repairs</h2>
                
                <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                    <label class="block text-sm font-bold text-gray-700">Base Boat Value (LKR)</label>
                    <input type="number" id="base-boat-value" value="10000000" oninput="report.updateBaseValue(this.value)" class="w-full p-2 border border-gray-300 rounded mt-1">
                    <p class="text-xs text-gray-500 mt-1">Default is 10,000,000. Change if necessary.</p>
                </div>

                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Additional Investments (New Items)</h3>
                    <div id="boat-value-entries"></div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <input type="text" id="cbv-desc" placeholder="Item Description" class="p-2 border rounded-lg flex-grow">
                        <input type="number" id="cbv-amount" placeholder="Amount" class="p-2 border rounded-lg w-full sm:w-32">
                        <button onclick="report.addEntry('currentBoatValues', 'cbv-desc', 'cbv-amount')" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add</button>
                    </div>
                    <div class="total-box mt-2 bg-green-50 border-l-4 border-green-600">
                        Total Boat Value (Base + New): <span id="cbv-total">0.00 LKR</span>
                    </div>
                </div>

                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Boat Repairs</h3>
                    <div id="boat-repairs-entries"></div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <input type="text" id="br-desc" placeholder="Description" class="p-2 border rounded-lg flex-grow">
                        <input type="number" id="br-amount" placeholder="Amount" class="p-2 border rounded-lg w-full sm:w-32">
                        <button onclick="report.addEntry('boatRepairs', 'br-desc', 'br-amount')" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add</button>
                    </div>
                    <div class="total-box mt-2 bg-purple-50 border-l-4 border-purple-600">Total Repairs: <span id="br-total">0.00 LKR</span></div>
                </div>
            </div>

            <div class="section-card p-6 space-y-6">
                <h2 class="text-xl font-semibold text-gray-800">5. Loans and Liabilities</h2>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Loans Settled (Repayments)</h3>
                    <div id="loans-settled-entries"></div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <input type="text" id="ls-desc" placeholder="Description" class="p-2 border rounded-lg flex-grow">
                        <input type="number" id="ls-amount" placeholder="Amount" class="p-2 border rounded-lg w-full sm:w-32">
                        <button onclick="report.addEntry('loansSettled', 'ls-desc', 'ls-amount')" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add</button>
                    </div>
                    <div class="total-box mt-2 bg-red-50 border-l-4 border-red-500">Total Loans Settled: <span id="ls-total">0.00 LKR</span></div>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Pending Loans</h3>
                    <div id="pending-loans-entries"></div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <input type="text" id="pl-desc" placeholder="Description" class="p-2 border rounded-lg flex-grow">
                        <input type="number" id="pl-amount" placeholder="Amount" class="p-2 border rounded-lg w-full sm:w-32">
                        <button onclick="report.addEntry('pendingLoans', 'pl-desc', 'pl-amount')" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add</button>
                    </div>
                    <div class="total-box mt-2 bg-red-50 border-l-4 border-red-500">Total Pending Loans: <span id="pl-total">0.00 LKR</span></div>
                </div>
            </div>

            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">6. Salaries / Wages Paid</h2>
                <div id="salaries-entries"></div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                    <input type="text" id="sal-desc" placeholder="Name/Description" class="p-2 border rounded-lg flex-grow">
                    <input type="number" id="sal-amount" placeholder="Amount" class="p-2 border rounded-lg w-full sm:w-32">
                    <button onclick="report.addEntry('salaries', 'sal-desc', 'sal-amount')" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add</button>
                </div>
                <div class="total-box mt-4 bg-gray-100 border-l-4 border-gray-600">Total Salaries: <span id="sal-total">0.00 LKR</span></div>
            </div>

            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">7. Fish Sales (Revenue)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kg</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price/Kg</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                <th class="px-3 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="sales-entries" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                    <input type="text" id="sale-category" placeholder="Category" class="p-2 border rounded-lg w-full">
                    <input type="number" id="sale-weight" placeholder="Kg" class="p-2 border rounded-lg w-full sm:w-20">
                    <input type="number" id="sale-price" placeholder="Price" class="p-2 border rounded-lg w-full sm:w-28">
                    <button onclick="report.addSaleEntry()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add Sale</button>
                </div>
                <div class="total-box mt-4 bg-indigo-100 border-l-4 border-indigo-600 text-lg">Net Sales: <span id="net-sales-total">0.00 LKR</span></div>
            </div>

            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">8. Profit & Expense Flow</h2>

                <div class="space-y-2 text-sm md:text-base">
                    <div class="flex justify-between border-b pb-1"><span class="font-medium">Net Sales</span><span id="p-net-sales" class="font-bold text-indigo-700">0.00 LKR</span></div>
                    
                    <div class="flex justify-between items-center border-t pt-2">
                        <label class="font-medium text-red-600">- Market Commission (%)</label>
                        <div class="flex items-center">
                            <input type="number" id="market-commission-rate" value="5" oninput="report.updateMarketCommission(this.value)" class="p-1 border rounded w-16 text-right mx-2 text-sm">
                            <span id="p-market-commission" class="text-red-600">0.00 LKR</span>
                        </div>
                    </div>

                    <div class="flex justify-between total-box bg-gray-50 border-l-4 border-gray-400"><span class="font-bold">Balance 1</span><span id="p-balance-1" class="font-extrabold">0.00 LKR</span></div>
                    <div class="flex justify-between border-t pt-2"><span class="font-medium text-red-600">- Departure Expenses</span><span id="p-deductible-expenses" class="text-red-600">0.00 LKR</span></div>
                    <div class="flex justify-between total-box bg-blue-50 border-l-4 border-blue-600"><span class="font-bold">Balance 2</span><span id="p-balance-2" class="font-extrabold text-blue-700">0.00 LKR</span></div>
                    
                    <div class="flex justify-between items-center border-t pt-2">
                        <label class="font-medium text-red-600">- Skipper Commission (%)</label>
                        <div class="flex items-center">
                            <input type="number" id="skipper-commission-rate" value="5" oninput="report.updateSkipperCommission(this.value)" class="p-1 border rounded w-16 text-right mx-2 text-sm">
                            <span id="p-skipper-commission" class="text-red-600">0.00 LKR</span>
                        </div>
                    </div>

                    <div class="flex justify-between total-box bg-yellow-100 border-l-4 border-yellow-600 text-lg"><span class="font-bold">Final Distributable Balance</span><span id="p-final-balance" class="font-extrabold text-yellow-800">0.00 LKR</span></div>
                    <div class="h-4"></div>
                    <div class="flex justify-between border-t pt-4"><span class="font-bold text-gray-700">Owner's Share (50%)</span><span id="p-owner-profit" class="font-extrabold text-blue-700">0.00 LKR</span></div>
                
                    <div class="border-t pt-4 mt-4 bg-gray-50 p-3 rounded">
                         <h3 class="font-bold text-gray-800 mb-2">Net Owner's Profit/Loss</h3>
                         <p class="text-xs text-gray-500 italic mb-2">Formula: Owner's Share - New Investments - Repairs - Loans Settled - Salaries</p>
                         <p class="text-xs text-red-500 italic mb-2">*Note: Base Boat Value (10M) is NOT subtracted here, only new expenses.</p>
                         <div class="flex justify-between items-center">
                            <span class="font-bold text-lg">Net Owner Profit:</span>
                            <span id="net-owner-profit-display" class="font-extrabold text-xl">0.00 LKR</span>
                         </div>
                    </div>

                    <div class="border-t pt-4 mt-4 bg-green-50 p-3 rounded border border-green-200">
                        <h3 class="font-bold text-gray-800 mb-2">Bank Deposited Today</h3>
                        <p class="text-xs text-gray-500 italic mb-2">Formula: Owner's Profit + Loans Settled - Salaries/Wages</p>
                        <div class="flex justify-between items-center">
                           <span class="font-bold text-lg text-green-900">Total Deposit:</span>
                           <span id="bank-deposit-display" class="font-extrabold text-xl text-green-700">0.00 LKR</span>
                        </div>
                   </div>
                </div>

                <h3 class="font-bold text-gray-800 mt-6 mb-2">Crew Salary Distribution (50% Remaining)</h3>
                <div id="crew-distribution" class="space-y-2 mb-4"></div>
                <div class="flex gap-2">
                    <input type="text" id="crew-name" placeholder="Crew Name" class="p-2 border rounded-lg flex-grow">
                    <button onclick="report.addCrewMember()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Add Crew</button>
                </div>
                <div class="total-box mt-2 bg-gray-100">Total Crew Share: <span id="p-crew-total">0.00 LKR</span></div>
            </div>

            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-2">9. Notes</h2>
                <textarea id="report-note" rows="3" oninput="report.updateNote(this.value)" class="w-full border rounded p-2"></textarea>
            </div>
        </div>

        <div class="p-4 bg-white rounded-xl shadow-lg">
             <button onclick="report.showPdfSummaryModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg">
                Generate & Download PDF
            </button>
        </div>
    </div>

    <div id="pdf-template">
        <div class="text-center mb-4">
            <h1 id="pdf-report-title" class="text-2xl font-bold uppercase">ARRIVAL REPORT</h1>
            <p id="pdf-boat-date" class="text-sm text-gray-600"></p>
        </div>

        <div class="pdf-header-strip">Summary of Financial Activity</div>

        <div class="pdf-section-title">1. Net Sales (Revenue)</div>
        <table>
            <thead><tr><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
            <tbody id="pdf-sales-breakdown"></tbody>
            <tfoot><tr class="bg-gray-100"><td class="font-bold">Total Net Sales</td><td class="text-right font-bold" id="pdf-net-sales-total"></td></tr></tfoot>
        </table>

        <div class="pdf-section-title">2. Expenditure</div>
        <table>
            <thead><tr><th>Deductible Expenses</th><th style="text-align:right">Amount</th></tr></thead>
            <tbody id="pdf-expenses-breakdown"></tbody> <tfoot><tr class="bg-gray-100"><td class="font-bold">Total Deductible Expenses</td><td class="text-right font-bold" id="pdf-total-deductible-expenses"></td></tr></tfoot>
        </table>

        <div class="pdf-section-title">3. Salaries / Wages</div>
         <table>
             <tbody id="pdf-salaries-breakdown"></tbody>
             <tfoot><tr class="bg-gray-100"><td class="font-bold">Total Salaries</td><td class="text-right font-bold" id="pdf-salaries-total"></td></tr></tfoot>
         </table>

        <div class="pdf-section-title">4. Liabilities</div>
        <table>
            <thead><tr><th>Loans Settled</th><th style="text-align:right">Amount</th></tr></thead>
            <tbody id="pdf-loans-settled-breakdown"></tbody>
        </table>
        <table>
            <thead><tr><th>Pending Loans</th><th style="text-align:right">Amount</th></tr></thead>
            <tbody id="pdf-pending-loans-breakdown"></tbody>
        </table>

        <div class="pdf-section-title">5. Boat Value & Repairs</div>
        <table>
            <thead><tr><th>Investment / Repair</th><th style="text-align:right">Amount</th></tr></thead>
            <tr><td>Base Boat Value</td><td class="text-right" id="pdf-base-value"></td></tr>
            <tbody id="pdf-boat-value-breakdown"></tbody>
            <tbody id="pdf-repairs-breakdown"></tbody>
            <tfoot><tr class="bg-gray-100"><td class="font-bold">Total Value (Base+New+Repairs)</td><td class="text-right font-bold" id="pdf-value-repair-total"></td></tr></tfoot>
        </table>

        <div class="pdf-header-strip">Profit & Loss Distribution</div>
        <table>
            <tr><td>Net Sales</td><td class="text-right" id="s-net-sales-pdf"></td></tr>
            <tr><td class="text-red-600">- Market Commission (<span id="s-market-comm-rate-pdf"></span>%)</td><td class="text-right text-red-600" id="s-market-commission-pdf"></td></tr>
            <tr class="font-bold bg-gray-100"><td>Balance 1</td><td class="text-right" id="s-balance1-pdf"></td></tr>
            <tr><td class="text-red-600">- Deductible Expenses</td><td class="text-right text-red-600" id="s-deductible-expenses-pdf"></td></tr>
            <tr class="font-bold bg-gray-100"><td>Balance 2</td><td class="text-right" id="s-balance2-pdf"></td></tr>
            <tr><td class="text-red-600">- Skipper Commission (<span id="s-skipper-comm-rate-pdf"></span>%)</td><td class="text-right text-red-600" id="s-skipper-commission-pdf"></td></tr>
            <tr class="font-bold text-lg"><td>Final Distributable Balance</td><td class="text-right" id="s-final-balance-pdf"></td></tr>
            <tr class="font-bold text-blue-700 text-lg bg-blue-50"><td>Owner's Share (50%)</td><td class="text-right" id="s-owner-profit-pdf"></td></tr>
        </table>

        <div class="pdf-section-title">Crew Salary Distribution (50%)</div>
        <table>
            <thead><tr><th>Crew Member</th><th style="text-align:right">Share</th></tr></thead>
            <tbody id="pdf-crew-breakdown"></tbody>
            <tfoot><tr class="bg-gray-100"><td class="font-bold">Total Crew Share</td><td class="text-right font-bold" id="s-crew-total-pdf"></td></tr></tfoot>
        </table>

        <div class="pdf-header-strip">Final Report Summary</div>
        <table style="border: 2px solid #333;">
            <tr class="bg-white"><td class="font-bold">Net Sales</td><td class="text-right" id="sum-net-sales-pdf"></td></tr>
            <tr class="bg-gray-50"><td class="font-bold">Boat Loaded & Extra Exp.</td><td class="text-right" id="sum-departure-expenditure-pdf"></td></tr>
            <tr class="bg-white"><td class="font-bold">Fuel Consumption</td><td class="text-right" id="sum-fuel-consumption-pdf"></td></tr>
            <tr class="bg-gray-50"><td class="font-bold">New Boat Investments</td><td class="text-right" id="sum-new-investments-pdf"></td></tr>
            <tr class="bg-white"><td class="font-bold">Boat Repairs</td><td class="text-right" id="sum-boat-repairs-pdf"></td></tr>
            <tr class="bg-gray-50"><td class="font-bold">Settled Loans</td><td class="text-right" id="sum-settled-loans-pdf"></td></tr>
            <tr class="bg-white"><td class="font-bold">Salaries / Wages</td><td class="text-right" id="sum-salary-wages-pdf"></td></tr>
            
            <tr class="bg-blue-100 border-t-2 border-blue-500">
                <td class="font-bold text-blue-900">Owner's Share</td>
                <td class="text-right font-bold text-blue-900" id="sum-profit-loss-pdf"></td>
            </tr>
            
            <tr>
                <td colspan="2" class="text-xs italic text-gray-500 p-2">
                    <strong>Calculation Logic for Net Owner Profit:</strong> Owner's Share - (New Investments + Repairs + Loans Settled + Salaries). <br>
                    * Note: Base Boat Value (10M) is excluded from this specific trip calculation.
                </td>
            </tr>

            <tr class="bg-gray-200 border-t-2 border-gray-600">
                <td class="font-bold text-lg">FINAL NET OWNER PROFIT/LOSS</td>
                <td class="text-right font-bold text-lg" id="sum-net-owner-profit-pdf"></td>
            </tr>

            <tr class="bg-green-100 border-t-2 border-green-600">
                <td class="font-bold text-lg text-green-900">BANK DEPOSITED TODAY</td>
                <td class="text-right font-bold text-lg text-green-900" id="sum-bank-deposited-pdf"></td>
            </tr>
            <tr>
                 <td colspan="2" class="text-xs italic text-green-700 p-1">
                    Formula: Owner's Profit + Loans Settled - Salaries/Wages
                 </td>
            </tr>
        </table>

        <div class="mt-4 pt-2 border-t border-gray-300">
            <h3 class="font-bold text-sm">Note:</h3>
            <p id="pdf-note-content" class="text-xs italic"></p>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm m-4">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <p id="modal-message" class="mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded">Cancel</button>
                <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">Confirm</button>
            </div>
        </div>
    </div>

    <div id="pdf-summary-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Download PDF</h2>
            <input type="text" id="pdf-title-input" placeholder="Custom PDF Title" class="w-full border p-2 rounded mb-4">
            <div class="space-y-2 border-t border-b py-4 mb-4">
                <div class="flex justify-between"><span class="text-gray-600">Owner's Share:</span><span id="pdf-summary-owner-share" class="font-bold"></span></div>
                <div class="flex justify-between"><span class="text-gray-800 font-bold">Net Profit:</span><span id="pdf-summary-net-profit" class="font-bold"></span></div>
                <div class="flex justify-between text-green-700"><span class="font-bold">Bank Deposit:</span><span id="pdf-summary-bank-deposit" class="font-bold"></span></div>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="report.hidePdfSummaryModal()" class="bg-gray-300 py-2 px-4 rounded">Cancel</button>
                <button onclick="generatePDF()" class="bg-blue-600 text-white py-2 px-4 rounded">Download</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'boatReportDataV2';

        function showModal(title, message, isConfirm, onConfirm) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const btnConfirm = document.getElementById('modal-confirm');
            const btnCancel = document.getElementById('modal-cancel');
            
            modal.classList.remove('hidden'); modal.classList.add('flex');
            btnConfirm.style.display = isConfirm ? 'block' : 'none';
            btnCancel.textContent = isConfirm ? 'Cancel' : 'OK';
            
            btnConfirm.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); if (onConfirm) onConfirm(); };
            btnCancel.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); };
        }

        class ArrivalReport {
            constructor() {
                this.defaultData = {
                    date: new Date().toISOString().substring(0, 10),
                    boatName: '',
                    marketCommissionRate: 5,
                    skipperCommissionRate: 5,
                    baseBoatValue: 10000000, // Default 10 Million
                    boatLoadedCosts: [],
                    extraExpenses: [],
                    diesel: { liters: 0, pricePerLiter: 277, totalCost: 0 },
                    currentBoatValues: [], // New investments only
                    boatRepairs: [],
                    loansSettled: [],
                    pendingLoans: [],
                    salaries: [],
                    sales: [],
                    crew: [],
                    note: ''
                };
                this.data = JSON.parse(JSON.stringify(this.defaultData));
                this.isLoaded = false;
                this.init();
            }

            init() {
                document.getElementById('arrival-date').value = this.data.date;
                document.getElementById('boat-name').value = this.data.boatName;
                document.getElementById('market-commission-rate').value = this.data.marketCommissionRate;
                document.getElementById('skipper-commission-rate').value = this.data.skipperCommissionRate;
                document.getElementById('diesel-liters').value = this.data.diesel.liters;
                document.getElementById('base-boat-value').value = this.data.baseBoatValue;
                document.getElementById('report-note').value = this.data.note;
            }

            loadReport() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    this.data = { ...JSON.parse(JSON.stringify(this.defaultData)), ...JSON.parse(stored) };
                    this.init();
                }
                this.isLoaded = true;
                this.updateAll();
            }

            saveReport() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
                const msg = document.getElementById('save-message');
                msg.textContent = 'Saved!';
                setTimeout(() => msg.textContent = '', 2000);
            }

            clearReportData() {
                localStorage.removeItem(STORAGE_KEY);
                this.data = JSON.parse(JSON.stringify(this.defaultData));
                this.init();
                this.updateAll();
                showModal('Success', 'Data cleared.', false);
            }
            
            showClearModal() {
                showModal('Confirm', 'Clear all data?', true, () => this.clearReportData());
            }

            addEntry(key, descId, amtId) {
                const d = document.getElementById(descId).value.trim();
                const a = parseFloat(document.getElementById(amtId).value);
                if (d && a > 0) {
                    this.data[key].push({ desc: d, amount: a });
                    document.getElementById(descId).value = '';
                    document.getElementById(amtId).value = '';
                    this.updateAll(); this.saveReport();
                } else showModal('Error', 'Invalid Input', false);
            }

            removeEntry(key, idx) {
                this.data[key].splice(idx, 1);
                this.updateAll(); this.saveReport();
            }

            addSaleEntry() {
                const c = document.getElementById('sale-category').value;
                const w = parseFloat(document.getElementById('sale-weight').value);
                const p = parseFloat(document.getElementById('sale-price').value);
                if (c && w > 0 && p > 0) {
                    this.data.sales.push({ category: c, weight: w, priceKg: p, total: w * p });
                    document.getElementById('sale-category').value = '';
                    document.getElementById('sale-weight').value = '';
                    document.getElementById('sale-price').value = '';
                    this.updateAll(); this.saveReport();
                }
            }

            removeSale(idx) { this.data.sales.splice(idx, 1); this.updateAll(); this.saveReport(); }

            addCrewMember() {
                const n = document.getElementById('crew-name').value.trim();
                if (n) {
                    this.data.crew.push({ name: n, share: 0 });
                    document.getElementById('crew-name').value = '';
                    this.updateAll(); this.saveReport();
                }
            }
            removeCrew(idx) { this.data.crew.splice(idx, 1); this.updateAll(); this.saveReport(); }

            updateBaseValue(val) { this.data.baseBoatValue = parseFloat(val) || 0; this.updateAll(); this.saveReport(); }
            updateDate(val) { this.data.date = val; this.saveReport(); }
            updateboatName(val) { this.data.boatName = val; this.saveReport(); }
            updateNote(val) { this.data.note = val; this.saveReport(); }
            updateMarketCommission(val) { this.data.marketCommissionRate = parseFloat(val) || 0; this.updateAll(); this.saveReport(); }
            updateSkipperCommission(val) { this.data.skipperCommissionRate = parseFloat(val) || 0; this.updateAll(); this.saveReport(); }
            calculateDiesel() {
                const l = parseFloat(document.getElementById('diesel-liters').value) || 0;
                this.data.diesel.liters = l;
                this.data.diesel.totalCost = l * this.data.diesel.pricePerLiter;
                this.updateAll(); this.saveReport();
            }

            sum(key) { return this.data[key].reduce((a, b) => a + (b.amount || 0), 0); }
            fmt(num) { return (num || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' LKR'; }

            renderList(key, elId) {
                const div = document.getElementById(elId);
                div.innerHTML = this.data[key].map((i, idx) => `
                    <div class="flex justify-between text-sm border-b p-1">
                        <span>${i.desc}</span><span class="font-mono">${this.fmt(i.amount)} <button onclick="report.removeEntry('${key}',${idx})" class="text-red-500 ml-2">x</button></span>
                    </div>`).join('') || '<p class="text-xs text-gray-400">No entries</p>';
            }

            updateAll() {
                if (!this.isLoaded) return;

                this.renderList('boatLoadedCosts', 'boat-loaded-cost-entries');
                this.renderList('extraExpenses', 'extra-expenses-entries');
                this.renderList('currentBoatValues', 'boat-value-entries'); // New Investments
                this.renderList('boatRepairs', 'boat-repairs-entries');
                this.renderList('loansSettled', 'loans-settled-entries');
                this.renderList('pendingLoans', 'pending-loans-entries');
                this.renderList('salaries', 'salaries-entries');

                // Sales Table
                document.getElementById('sales-entries').innerHTML = this.data.sales.map((s, i) => `
                    <tr>
                        <td class="px-3 py-2">${s.category}</td>
                        <td class="px-3 py-2">${s.weight}</td>
                        <td class="px-3 py-2">${s.priceKg}</td>
                        <td class="px-3 py-2 font-medium">${this.fmt(s.total)}</td>
                        <td class="px-3 py-2"><button onclick="report.removeSale(${i})" class="text-red-500">Remove</button></td>
                    </tr>`).join('');

                // Totals
                const blc = this.sum('boatLoadedCosts');
                const ee = this.sum('extraExpenses');
                const newInvestments = this.sum('currentBoatValues'); // Just the new stuff
                const totalBoatVal = this.data.baseBoatValue + newInvestments; // Base + New
                const br = this.sum('boatRepairs');
                const ls = this.sum('loansSettled');
                const pl = this.sum('pendingLoans');
                const sal = this.sum('salaries');
                const fuel = this.data.diesel.totalCost;

                document.getElementById('blc-total').textContent = this.fmt(blc);
                document.getElementById('ee-total').textContent = this.fmt(ee);
                document.getElementById('cbv-total').textContent = this.fmt(totalBoatVal); // Show Total
                document.getElementById('br-total').textContent = this.fmt(br);
                document.getElementById('ls-total').textContent = this.fmt(ls);
                document.getElementById('pl-total').textContent = this.fmt(pl);
                document.getElementById('sal-total').textContent = this.fmt(sal);
                document.getElementById('diesel-cost-total').textContent = this.fmt(fuel);

                // Profit Logic
                const netSales = this.data.sales.reduce((a, b) => a + b.total, 0);
                const deducExp = blc + ee + fuel;
                const mktComm = netSales * (this.data.marketCommissionRate / 100);
                const bal1 = netSales - mktComm;
                const bal2 = bal1 - deducExp;
                const skipComm = (bal2 > 0 ? bal2 : 0) * (this.data.skipperCommissionRate / 100);
                const finalBal = (bal2 > 0 ? bal2 : 0) - skipComm;
                const ownerShare = finalBal * 0.5;
                const crewPool = finalBal - ownerShare;

                // Crew Dist
                const crewCount = this.data.crew.length || 1;
                const sharePerCrew = crewPool / crewCount;
                this.data.crew.forEach(c => c.share = sharePerCrew);
                document.getElementById('crew-distribution').innerHTML = this.data.crew.map((c, i) => 
                    `<div class="flex justify-between text-sm border-b p-1"><span>${c.name}</span><span class="text-blue-700 font-bold">${this.fmt(c.share)} <button onclick="report.removeCrew(${i})" class="text-red-500 ml-2">x</button></span></div>`
                ).join('');

                // Update UI Text
                document.getElementById('net-sales-total').textContent = this.fmt(netSales);
                document.getElementById('p-net-sales').textContent = this.fmt(netSales);
                document.getElementById('p-market-commission').textContent = '-' + this.fmt(mktComm);
                document.getElementById('p-balance-1').textContent = this.fmt(bal1);
                document.getElementById('p-deductible-expenses').textContent = '-' + this.fmt(deducExp);
                document.getElementById('p-balance-2').textContent = this.fmt(bal2);
                document.getElementById('p-skipper-commission').textContent = '-' + this.fmt(skipComm);
                document.getElementById('p-final-balance').textContent = this.fmt(finalBal);
                document.getElementById('p-owner-profit').textContent = this.fmt(ownerShare);
                document.getElementById('p-crew-total').textContent = this.fmt(crewPool);

                // Net Owner Profit Calculation (Subtract ONLY NEW investments, NOT 10M Base)
                // Formula: OwnerShare - (NewInvestments + Repairs + LoansSettled + Salaries)
                const netOwnerProfit = ownerShare - (newInvestments + br + ls + sal);
                
                const netProfitEl = document.getElementById('net-owner-profit-display');
                netProfitEl.textContent = this.fmt(netOwnerProfit);
                netProfitEl.className = netOwnerProfit >= 0 ? 'font-extrabold text-xl text-blue-600' : 'font-extrabold text-xl text-red-600';

                // Bank Deposited Calculation
                // Formula: Owner's Profit + Loans Settled - Salaries
                // Note: "Loans Settled" is usually an expense, but user requested this specific formula.
                const bankDeposit = ownerShare + ls - sal;
                document.getElementById('bank-deposit-display').textContent = this.fmt(bankDeposit);

                return { netSales, deducExp, netOwnerProfit, bankDeposit, ownerShare, newInvestments, br, ls, sal, mktComm, bal1, bal2, skipComm, finalBal, crewPool };
            }

            showPdfSummaryModal() {
                const calcs = this.updateAll();
                document.getElementById('pdf-summary-owner-share').textContent = this.fmt(calcs.ownerShare);
                document.getElementById('pdf-summary-net-profit').textContent = this.fmt(calcs.netOwnerProfit);
                document.getElementById('pdf-summary-bank-deposit').textContent = this.fmt(calcs.bankDeposit);
                document.getElementById('pdf-summary-modal').classList.remove('hidden');
                document.getElementById('pdf-summary-modal').classList.add('flex');
            }
            hidePdfSummaryModal() {
                document.getElementById('pdf-summary-modal').classList.add('hidden');
                document.getElementById('pdf-summary-modal').classList.remove('flex');
            }
        }

        const report = new ArrivalReport();
        window.report = report;
        report.loadReport();

        // PDF Generation
        function renderPdfRows(key, elId) {
            const el = document.getElementById(elId);
            const data = report.data[key];
            if(!data.length) { el.innerHTML = ''; return; }
            el.innerHTML = data.map(i => `<tr><td>${i.desc}</td><td class="text-right">${report.fmt(i.amount)}</td></tr>`).join('');
        }

        function generatePDF() {
            report.hidePdfSummaryModal();
            const c = report.updateAll(); // Get current calculations
            
            document.getElementById('pdf-report-title').textContent = (document.getElementById('pdf-title-input').value || 'ARRIVAL REPORT');
            document.getElementById('pdf-boat-date').textContent = `Boat: ${report.data.boatName} | Date: ${report.data.date}`;

            // Sales
            document.getElementById('pdf-sales-breakdown').innerHTML = report.data.sales.map(s => `<tr><td>${s.category} (${s.weight}kg @ ${s.priceKg})</td><td class="text-right">${report.fmt(s.total)}</td></tr>`).join('');
            document.getElementById('pdf-net-sales-total').textContent = report.fmt(c.netSales);

            // Expenses (Combined for brevity)
            let expHtml = '';
            report.data.boatLoadedCosts.forEach(x => expHtml += `<tr><td>${x.desc}</td><td class="text-right">${report.fmt(x.amount)}</td></tr>`);
            report.data.extraExpenses.forEach(x => expHtml += `<tr><td>${x.desc}</td><td class="text-right">${report.fmt(x.amount)}</td></tr>`);
            expHtml += `<tr><td>Diesel (${report.data.diesel.liters}L)</td><td class="text-right">${report.fmt(report.data.diesel.totalCost)}</td></tr>`;
            document.getElementById('pdf-expenses-breakdown').innerHTML = expHtml;
            document.getElementById('pdf-total-deductible-expenses').textContent = report.fmt(c.deducExp);

            // Salaries
            renderPdfRows('salaries', 'pdf-salaries-breakdown');
            document.getElementById('pdf-salaries-total').textContent = report.fmt(c.sal);

            // Loans
            renderPdfRows('loansSettled', 'pdf-loans-settled-breakdown');
            renderPdfRows('pendingLoans', 'pdf-pending-loans-breakdown');

            // Boat Value
            document.getElementById('pdf-base-value').textContent = report.fmt(report.data.baseBoatValue);
            renderPdfRows('currentBoatValues', 'pdf-boat-value-breakdown');
            renderPdfRows('boatRepairs', 'pdf-repairs-breakdown');
            document.getElementById('pdf-value-repair-total').textContent = report.fmt(report.data.baseBoatValue + c.newInvestments + c.br);

            // Profit Flow
            document.getElementById('s-net-sales-pdf').textContent = report.fmt(c.netSales);
            document.getElementById('s-market-comm-rate-pdf').textContent = report.data.marketCommissionRate;
            document.getElementById('s-market-commission-pdf').textContent = '-' + report.fmt(c.mktComm);
            document.getElementById('s-balance1-pdf').textContent = report.fmt(c.bal1);
            document.getElementById('s-deductible-expenses-pdf').textContent = '-' + report.fmt(c.deducExp);
            document.getElementById('s-balance2-pdf').textContent = report.fmt(c.bal2);
            document.getElementById('s-skipper-comm-rate-pdf').textContent = report.data.skipperCommissionRate;
            document.getElementById('s-skipper-commission-pdf').textContent = '-' + report.fmt(c.skipComm);
            document.getElementById('s-final-balance-pdf').textContent = report.fmt(c.finalBal);
            document.getElementById('s-owner-profit-pdf').textContent = report.fmt(c.ownerShare);

            // Crew
            document.getElementById('pdf-crew-breakdown').innerHTML = report.data.crew.map(cr => `<tr><td>${cr.name}</td><td class="text-right">${report.fmt(cr.share)}</td></tr>`).join('');
            document.getElementById('s-crew-total-pdf').textContent = report.fmt(c.crewPool);

            // Final Summary
            document.getElementById('sum-net-sales-pdf').textContent = report.fmt(c.netSales);
            document.getElementById('sum-departure-expenditure-pdf').textContent = report.fmt(c.deducExp); // Actually only Departure + Fuel
            document.getElementById('sum-fuel-consumption-pdf').textContent = report.fmt(report.data.diesel.totalCost);
            document.getElementById('sum-new-investments-pdf').textContent = report.fmt(c.newInvestments);
            document.getElementById('sum-boat-repairs-pdf').textContent = report.fmt(c.br);
            document.getElementById('sum-settled-loans-pdf').textContent = report.fmt(c.ls);
            document.getElementById('sum-salary-wages-pdf').textContent = report.fmt(c.sal);
            document.getElementById('sum-profit-loss-pdf').textContent = report.fmt(c.ownerShare);
            
            // Net Profit
            const nplEl = document.getElementById('sum-net-owner-profit-pdf');
            nplEl.textContent = report.fmt(c.netOwnerProfit);
            nplEl.style.color = c.netOwnerProfit >= 0 ? 'blue' : 'red';

            // Bank Deposit
            document.getElementById('sum-bank-deposited-pdf').textContent = report.fmt(c.bankDeposit);

            // Note
            document.getElementById('pdf-note-content').textContent = report.data.note;

            // Generate
            const el = document.getElementById('pdf-template');
            el.style.display = 'block';
            
            html2canvas(el, { scale: 2, useCORS: true }).then(canvas => {
                el.style.display = 'none';
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                let pageNum = 1;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                
                // Footer Page 1
                pdf.setFontSize(9);
                pdf.text(`Page ${pageNum}`, 200, 290, { align: 'right' });

                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pageNum++;
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    
                    // Header on subsequent pages
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(0, 0, 210, 10, 'F'); // Whiteout top overlap
                    pdf.setFontSize(10);
                    pdf.text("Arrival Report - Continued", 10, 8);

                    // Footer on subsequent pages
                    pdf.setFontSize(9);
                    pdf.text(`Page ${pageNum}`, 200, 290, { align: 'right' });
                    
                    heightLeft -= pageHeight;
                }
                pdf.save(`${report.data.boatName}_Report.pdf`);
            });
        }
    </script>
</body>
</html>
