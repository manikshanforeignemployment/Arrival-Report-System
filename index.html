<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Ensures proper scaling on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrival Report - Boat Financial System (LKR)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load required libraries for PDF generation (jsPDF and html2canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Use the Inter font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f6f9; /* Light gray background */
        }
        /* Custom styles for cards and totals */
        .section-card { 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        .total-box { 
            background-color: #e2f5ff; 
            border-left: 4px solid #007bff; 
            padding: 0.5rem 1rem; 
            font-weight: 700; 
            border-radius: 0.25rem;
        }
        
        /* --- Styles for the hidden PDF template --- */
        .pdf-section { 
            padding: 10px 0; 
            border-bottom: 1px solid #ddd; 
        }
        /* pdf-item is no longer the primary layout, but keep for tables */
        .pdf-item { 
            display: flex; 
            justify-content: space-between; 
            font-size: 14px; 
            margin-bottom: 4px; 
        }
        .pdf-total { 
            font-weight: 700; 
            background-color: #f0f0f0; 
            padding: 4px;
            border-top: 1px solid #ccc;
        }
        .pdf-header { 
            background-color: #004b8d; /* Dark Blue (Changed from Dark Teal) */
            color: white; 
            padding: 10px; 
            font-weight: 700; 
            margin-bottom: 0; /* Removed margin */
            font-size: 1.125rem; /* Reduced from 1.25rem */
            border-radius: 0.25rem 0.25rem 0 0; /* Align with table */
        }

        /* Hidden PDF template for clean report capture. Fixed A4 width. */
        #pdf-template {
            width: 210mm; /* A4 width */
            margin: 0 auto;
            display: none; /* Keep it hidden from the user */
            padding: 20px;
            box-sizing: border-box;
            background-color: #ffffff; /* Ensure it has a white background for capture */
            font-family: 'Inter', sans-serif; /* Ensure font is applied */
        }

        /* PDF Table Styles */
        #pdf-template table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
            font-size: 12px; /* Reduced from 14px */
        }
        #pdf-template th, #pdf-template td {
            border: 1px solid #ddd;
            padding: 6px; /* Reduced from 8px */
            text-align: left;
            /* Ensure text wrapping */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        #pdf-template th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        #pdf-template .pdf-section h2 {
            border-bottom: 2px solid #004b8d;
            padding-bottom: 4px;
            font-size: 1.125rem; /* Reduced from 1.25rem */
            font-weight: 700;
            margin-bottom: 8px;
        }
        #pdf-template .pdf-section {
            border-bottom: none; /* Remove old border, tables will separate sections */
            padding-top: 0;
        }
        #pdf-template .final-summary-table td {
             border: 1px solid #ddd;
        }
        /* End PDF Table Styles */

        /* Simple toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input { display: none; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(22px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main container, centered and responsive -->
    <div class="max-w-4xl mx-auto space-y-8" id="report-container">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Arrival Report (LKR)</h1>

        <!-- Control Buttons -->
        <div class="flex flex-col space-y-4 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
                    <button onclick="report.saveReport()" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                        Save Report
                    </button>
                    <button onclick="report.showClearModal()" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                        Clear Data
                    </button>
                </div>
                <!-- Save message color changed to blue -->
                <span id="save-message" class="text-sm pt-2 sm:pt-0 font-medium text-blue-600"></span>
            </div>
            <!-- Download PDF button removed from here -->
        </div>

        <!-- The main content container (Interactive Form) -->
        <div id="interactive-content" class="space-y-8">

            <!-- Report Info Section -->
            <div class="section-card p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="board-name" class="block text-lg font-medium text-gray-700 mb-2">Board Name</label>
                    <input type="text" id="board-name" oninput="report.updateBoardName(this.value)"
                           placeholder="Enter board/boat name"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="arrival-date" class="block text-lg font-medium text-gray-700 mb-2">Arrival Date</label>
                    <input type="date" id="arrival-date" onchange="report.updateDate(this.value)"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
            </div>

            <!-- Expense Input Card (Sections 1, 2) -->
            <div id="expense-sections" class="space-y-6">
                <!-- Boat Loaded Cost -->
                <div class="section-card p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">1. Boat Loaded Cost (Departure Expenses)</h2>
                    <div id="boat-loaded-cost-entries"></div>
                    <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-4 space-y-2 sm:space-y-0">
                        <input type="text" id="blc-desc" placeholder="Description (e.g., Ice)" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                        <input type="number" id="blc-amount" placeholder="Amount (LKR)" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32" min="0">
                        <button onclick="report.addEntry('boatLoadedCosts', 'blc-desc', 'blc-amount')" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add</button>
                    </div>
                    <div class="total-box mt-4">Total Boat Loaded Cost: <span id="blc-total">0.00 LKR</span></div>
                </div>

                <!-- Extra Expenses -->
                <div class="section-card p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Extra Expenses</h2>
                    <div id="extra-expenses-entries"></div>
                    <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-4 space-y-2 sm:space-y-0">
                        <input type="text" id="ee-desc" placeholder="Description (e.g., Harbour fee)" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                        <input type="number" id="ee-amount" placeholder="Amount (LKR)" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32" min="0">
                        <button onclick="report.addEntry('extraExpenses', 'ee-desc', 'ee-amount')" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add</button>
                    </div>
                    <div class="total-box mt-4">Total Extra Expenses: <span id="ee-total">0.00 LKR</span></div>
                </div>
            </div>

            <!-- Diesel Consumption (Section 3) -->
            <div class="section-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">3. Fuel Consumption</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price per Liter (LKR)</label>
                        <input type="number" value="277.00" id="diesel-price" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="diesel-liters" class="block text-sm font-medium text-gray-700">Liters Consumed</label>
                        <input type="number" id="diesel-liters" value="0" oninput="report.calculateDiesel()" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" min="0">
                    </div>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="total-box bg-blue-100 border-blue-600">Total Fuel Cost: <span id="diesel-cost-total">0.00 LKR</span></div>
                </div>
            </div>

            <!-- Boat Value & Repairs (Section 4) -->
            <div class="section-card p-6 mt-6 space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">4. Boat Value & Repairs</h2>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Current Boat Value (Investments)</h3>
                    <div id="boat-value-entries"></div>
                    <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-2 space-y-2 sm:space-y-0">
                        <input type="text" id="cbv-desc" placeholder="Description (e.g., New Net)" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                        <input type="number" id="cbv-amount" placeholder="Amount (LKR)" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32" min="0">
                        <button onclick="report.addEntry('currentBoatValues', 'cbv-desc', 'cbv-amount')" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add</button>
                    </div>
                    <div class="total-box mt-2">Total Boat Value: <span id="cbv-total">0.00 LKR</span></div>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Boat Repairs</h3>
                    <div id="boat-repairs-entries"></div>
                    <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-2 space-y-2 sm:space-y-0">
                        <input type="text" id="br-desc" placeholder="Description (e.g., Engine Fix)" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                        <input type="number" id="br-amount" placeholder="Amount (LKR)" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32" min="0">
                        <button onclick="report.addEntry('boatRepairs', 'br-desc', 'br-amount')" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add</button>
                    </div>
                    <div class="total-box mt-2">Total Repairs: <span id="br-total">0.00 LKR</span></div>
                </div>
                <div class="total-box bg-purple-100 border-purple-600 mt-4">Combined Value/Repair Total: <span id="value-repair-combined-total">0.00 LKR</span></div>
            </div>

            <!-- Loans Section (Section 5) -->
            <div class="section-card p-6 mt-6 space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">5. Loans and Liabilities</h2>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Loans Settled (Repayments)</h3>
                    <div id="loans-settled-entries"></div>
                    <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-2 space-y-2 sm:space-y-0">
                        <input type="text" id="ls-desc" placeholder="Name/Description" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                        <input type="number" id="ls-amount" placeholder="Amount (LKR)" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32" min="0">
                        <button onclick="report.addEntry('loansSettled', 'ls-desc', 'ls-amount')" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add</button>
                    </div>
                    <div class="total-box mt-2">Total Loans Settled: <span id="ls-total">0.00 LKR</span></div>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Pending Loans</h3>
                    <div id="pending-loans-entries"></div>
                    <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-2 space-y-2 sm:space-y-0">
                        <input type="text" id="pl-desc" placeholder="Name/Description" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                        <input type="number" id="pl-amount" placeholder="Amount (LKR)" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32" min="0">
                        <button onclick="report.addEntry('pendingLoans', 'pl-desc', 'pl-amount')" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add</button>
                    </div>
                    <div class="total-box mt-2">Total Pending Loans: <span id="pl-total">0.00 LKR</span></div>
                </div>
                <div class="total-box bg-red-100 border-red-600 mt-4">Total Loan Liability: <span id="loans-combined-total">0.00 LKR</span></div>
            </div>

            <!-- Salaries / Wages Section (Section 6) -->
            <div class="section-card p-6 mt-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">6. Salaries / Wages Paid</h2>
                <div id="salaries-entries"></div>
                <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-4 space-y-2 sm:space-y-0">
                    <input type="text" id="sal-desc" placeholder="Name/Description" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                    <input type="number" id="sal-amount" placeholder="Amount (LKR)" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32" min="0">
                    <button onclick="report.addEntry('salaries', 'sal-desc', 'sal-amount')" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add</button>
                </div>
                <div class="total-box mt-4">Total Salaries/Wages Paid: <span id="sal-total">0.00 LKR</span></div>
            </div>

            <!-- Sales Section (Section 7) -->
            <div class="section-card p-6 mt-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">7. Fish Sales (Revenue)</h2>
                <!-- Responsive wrapper for table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight (Kg)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price/KG</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sales-entries" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="flex flex-col sm:flex-row justify-start sm:space-x-4 mt-4 space-y-2 sm:space-y-0">
                    <input type="text" id="sale-category" placeholder="Category" class="p-2 border border-gray-300 rounded-lg w-full sm:w-32">
                    <input type="number" id="sale-weight" placeholder="Kg" class="p-2 border border-gray-300 rounded-lg w-full sm:w-20" min="0">
                    <input type="number" id="sale-price" placeholder="Price/Kg" class="p-2 border border-gray-300 rounded-lg w-full sm:w-28" min="0">
                    <button onclick="report.addSaleEntry()" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add Sale</button>
                </div>
                <div class="total-box bg-indigo-100 border-indigo-600 mt-4 text-lg">Net Sales (Revenue Total): <span id="net-sales-total">0.00 LKR</span></div>
            </div>

            <!-- Profit & Crew Distribution (Section 8) -->
            <div class="section-card p-6 mt-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">8. Profit & Expense Flow</h2>

                <div id="profit-flow" class="space-y-3 text-base md:text-lg">
                    <div class="flex justify-between border-b pb-1"><span class="font-medium">Net Sales</span><span id="p-net-sales" class="font-bold text-indigo-700">0.00 LKR</span></div>
                    
                    <!-- Editable Market Commission -->
                    <div class="flex justify-between items-center border-t pt-2 border-gray-200">
                        <label for="market-commission-rate" class="font-medium flex-shrink-0">- Market Commission (%)</label>
                        <input type="number" id="market-commission-rate" value="5" oninput="report.updateMarketCommission(this.value)"
                               class="p-1 border border-gray-300 rounded-lg w-20 text-right mx-2">
                        <span id="p-market-commission" class="text-red-600 font-medium">0.00 LKR</span>
                    </div>

                    <div class="flex justify-between total-box bg-gray-50 border-gray-400"><span class="font-medium">Balance (After Market Commission)</span><span id="p-balance-1" class="font-extrabold text-gray-800">0.00 LKR</span></div>
                    <div class="flex justify-between border-t pt-2 border-gray-200"><span class="font-medium">- Deductible Boat-Loaded Expenses</span><span id="p-deductible-expenses" class="text-red-600">0.00 LKR</span></div>
                    <!-- Balance 2 color changed to blue -->
                    <div class="flex justify-between total-box bg-blue-50 border-blue-600"><span class="font-medium">Balance (After Expenses)</span><span id="p-balance-2" class="font-extrabold text-blue-700">0.00 LKR</span></div>
                    
                    <!-- Editable Skipper Commission -->
                    <div class="flex justify-between items-center border-t pt-2 border-gray-200">
                        <label for="skipper-commission-rate" class="font-medium flex-shrink-0">- Skipper Commission (%)</label>
                        <input type="number" id="skipper-commission-rate" value="5" oninput="report.updateSkipperCommission(this.value)"
                               class="p-1 border border-gray-300 rounded-lg w-20 text-right mx-2">
                        <span id="p-skipper-commission" class="text-red-600 font-medium">0.00 LKR</span>
                    </div>

                    <div class="flex justify-between total-box bg-yellow-100 border-yellow-600 text-xl md:text-2xl"><span class="font-bold">Final Distributable Balance</span><span id="p-final-balance" class="font-extrabold text-yellow-800">0.00 LKR</span></div>
                    <div class="h-4"></div>
                    <div class="flex justify-between border-t pt-4 border-gray-400"><span class="font-bold text-gray-700">Owner's Share (50% of Final Balance)</span><span id="p-owner-profit" class="font-extrabold text-blue-700">0.00 LKR</span></div>
                
                    <!-- Conditional Net Profit/Loss Display -->
                    <div class="border-t pt-4 mt-4 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-600">Show Net Owner's Profit/Loss</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="net-profit-toggle" onchange="report.toggleNetProfit(this)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="net-owner-profit-view" class="hidden">
                            <p class="text-sm text-gray-500 italic mb-2">Calculated as: (Owner's Share) - (Boat Value Investments) - (Boat Repairs) - (Loans Settled) - (Salaries)</p>
                            <div class="total-box bg-gray-100 border-gray-500 text-lg">
                                <span class="font-bold">Net Owner's Profit/Loss:</span>
                                <!-- Net owner profit color logic is handled in JS (will be blue or red) -->
                                <span id="net-owner-profit-display" class="font-extrabold">0.00 LKR</span>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mt-8 mb-4">Crew Member's Salary Distribution (50% Remaining)</h3>
                <div id="crew-distribution" class="space-y-2"></div>
                <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mt-4 space-y-2 sm:space-y-0">
                    <input type="text" id="crew-name" placeholder="Crew Member Name" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                    <button onclick="report.addCrewMember()" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">Add Crew Member</button>
                </div>
                <div class="total-box mt-4">Total Crew Share: <span id="p-crew-total">0.00 LKR</span></div>
            </div>

            <!-- Note Section -->
            <div class="section-card p-6 mt-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">9. Notes</h2>
                <textarea id="report-note" rows="4" oninput="report.updateNote(this.value)"
                          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                          placeholder="Add any additional notes for the report..."></textarea>
            </div>

        </div> <!-- End of interactive-content -->
        
        <!-- Download PDF Button new location (color changed to blue) -->
        <div class="p-4 bg-white rounded-xl shadow-lg">
             <button onclick="report.showPdfSummaryModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 text-lg">
                Generate & Download PDF
            </button>
        </div>
        
    </div>

    <!-- 
      ==================================================================
      HIDDEN PDF TEMPLATE
      This section is not visible to the user. It is styled specifically
      for html2canvas to capture and format into an A4 PDF.
      
      *** THIS SECTION HAS BEEN REFORMATTED TO USE TABLES ***
      ==================================================================
    -->
    <div id="pdf-template">
        <div class="text-center mb-6">
            <h1 id="pdf-report-title" class="text-2xl font-bold text-gray-800">ARRIVAL REPORT</h1> <!-- Reduced from 3xl -->
            <p id="pdf-board-date" class="text-base text-gray-600">Board: N/A | Date: N/A</p> <!-- Reduced from lg -->
        </div>
        <div class="pdf-header">Summary of Financial Activity (LKR)</div>

        <!-- REVENUE SECTION (Table Layout) -->
        <div class="pdf-section">
            <h2 class="text-xl font-bold mb-2">Net Sales (Revenue)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="pdf-sales-breakdown">
                    <!-- JS renders sales rows here -->
                </tbody>
                <tfoot class="font-bold">
                    <tr class="bg-gray-100">
                        <td class="py-2 px-1">Total Net Sales</td>
                        <td class="text-right py-2 px-1" id="pdf-net-sales-total">0.00 LKR</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- EXPENSES SECTION (Table Layout) -->
        <div class="pdf-section">
            <h2 class="text-xl font-bold mt-4 mb-2">Expenditure</h2>
            <table>
                <thead>
                    <tr>
                        <th>Boat Departure Expenditure</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="pdf-blc-breakdown">
                    <!-- JS renders blc rows here -->
                </tbody>
                <tbody id="pdf-ee-breakdown">
                    <!-- JS renders ee rows here -->
                </tbody>
                <tbody id="pdf-diesel-breakdown">
                    <!-- JS renders diesel row here -->
                </tbody>
                <tfoot class="font-bold">
                    <tr class="bg-gray-100">
                        <td class="py-2 px-1">Total Deductible Expenses</td>
                        <td class="text-right py-2 px-1" id="pdf-total-deductible-expenses">0.00 LKR</td>
                    </tr>
                </tfoot>
            </table>
            <table class="mt-4">
                <thead>
                    <tr>
                        <th>Other Expenditure</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="pdf-salaries-breakdown">
                    <!-- JS renders salaries rows here -->
                </tbody>
                <tfoot class="font-bold">
                    <tr class="bg-gray-100">
                        <td class="py-2 px-1">Total Salaries/Wages Paid</td>
                        <td class="text-right py-2 px-1" id="pdf-salaries-total">0.00 LKR</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- LIABILITIES SECTION (Table Layout) -->
        <div class="pdf-section">
            <h2 class="text-xl font-bold mt-4 mb-2">Liabilities</h2>
            <table>
                <thead>
                    <tr>
                        <th>Loans Settled</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="pdf-loans-settled-breakdown">
                    <!-- JS renders loans settled rows here -->
                </tbody>
            </table>
            <table class="mt-4">
                <thead>
                    <tr>
                        <th>Pending Loans (Due)</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="pdf-pending-loans-breakdown">
                    <!-- JS renders pending loans rows here -->
                </tbody>
            </table>
        </div>

        <!-- BOAT VALUE & REPAIRS SECTION (Table Layout) -->
        <div class="pdf-section">
            <h2 class="text-xl font-bold mt-4 mb-2">Boat Value & Repairs</h2>
            <table>
                <thead>
                    <tr>
                        <th>Boat Value (Investments)</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="pdf-boat-value-breakdown">
                    <!-- JS renders boat value rows here -->
                </tbody>
            </table>
            <table class="mt-4">
                <thead>
                    <tr>
                        <th>Boat Repairs</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="pdf-repairs-breakdown">
                    <!-- JS renders repairs rows here -->
                </tbody>
                <tfoot class="font-bold">
                    <tr class="bg-gray-100">
                        <td class="py-2 px-1">Total Value/Repairs</td>
                        <td class="text-right py-2 px-1" id="pdf-value-repair-total">0.00 LKR</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- SUMMARY / PROFIT FLOW -->
        <div class="pdf-header mt-8">Profit & Loss Distribution</div>
        <div class="pdf-section">
            <table>
                <tr class="bg-white"><td class="font-medium py-2 px-1">Net Sales</td><td class="text-right py-2 px-1" id="s-net-sales-pdf">0.00 LKR</td></tr>
                <tr class="bg-gray-50"><td class="font-medium text-red-600 py-2 px-1">- Market Commission (<span id="s-market-comm-rate-pdf">5</span>%)</td><td class="text-right text-red-600 py-2 px-1" id="s-market-commission-pdf">0.00 LKR</td></tr>
                <tr class="font-bold bg-white"><td class="py-2 px-1">Balance 1</td><td class="text-right py-2 px-1" id="s-balance1-pdf">0.00 LKR</td></tr>
                <tr class="bg-gray-50"><td class="font-medium text-red-600 py-2 px-1">- Deductible Departure Expenses</td><td class="text-right text-red-600 py-2 px-1" id="s-deductible-expenses-pdf">0.00 LKR</td></tr>
                <tr class="font-bold bg-white"><td class="py-2 px-1">Balance 2</td><td class="text-right py-2 px-1" id="s-balance2-pdf">0.00 LKR</td></tr>
                <tr class="bg-gray-50"><td class="font-medium text-red-600 py-2 px-1">- <span id="s-skipper-comm-rate-pdf">5</span>% Skipper Commission</td><td class="text-right text-red-600 py-2 px-1" id="s-skipper-commission-pdf">0.00 LKR</td></tr>
                <tr class="font-extrabold text-base bg-white"><td class="py-2 px-1">Final Balance</td><td class="text-right py-2 px-1" id="s-final-balance-pdf">0.00 LKR</td></tr> <!-- Reduced from lg -->
                <tr class="font-extrabold text-blue-700 text-base bg-gray-50"><td class="py-2 px-1">Owner's Share (50%)</td><td class="text-right py-2 px-1" id="s-owner-profit-pdf">0.00 LKR</td></tr> <!-- Reduced from lg -->
            </table>

            <h3 class="text-base font-bold mt-4 mb-2">Crew Salary Distribution (50% Remaining)</h3> <!-- Reduced from lg -->
            <table>
                <thead>
                    <tr>
                        <th>Crew Member</th>
                        <th>Share</th>
                    </tr>
                </thead>
                <tbody id="pdf-crew-breakdown">
                    <!-- JS renders crew rows here -->
                </tbody>
                <tfoot class="font-bold">
                    <tr class="bg-gray-100">
                        <td class="py-2 px-1">Total Crew Share</td>
                        <td class="text-right py-2 px-1" id="s-crew-total-pdf">0.00 LKR</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- FINAL SUMMARY TABLE -->
        <div class="pdf-header mt-8">Final Summary (Profit/Loss Metrics)</div>
        <table class="final-summary-table">
            <tbody class="divide-y divide-gray-200">
                <tr class="bg-white"><td class="px-2 py-2 font-bold">Net Sales</td><td class="px-2 py-2 text-right" id="sum-net-sales-pdf">0.00 LKR</td></tr>
                <tr class="bg-gray-50"><td class="px-2 py-2 font-bold">Boat Departure Expenditure</td><td class="px-2 py-2 text-right" id="sum-departure-expenditure-pdf">0.00 LKR</td></tr>
                <tr class="bg-white"><td class="px-2 py-2 font-bold">Fuel Consumption</td><td class="px-2 py-2 text-right" id="sum-fuel-consumption-pdf">0.00 LKR</td></tr>
                <tr class="bg-gray-50"><td class="px-2 py-2 font-bold">Current Boat Value (Investment)</td><td class="px-2 py-2 text-right" id="sum-current-boat-value-pdf">0.00 LKR</td></tr>
                <tr class="bg-white"><td class="px-2 py-2 font-bold">Boat Repairs</td><td class="px-2 py-2 text-right" id="sum-boat-repairs-pdf">0.00 LKR</td></tr>
                <tr class="bg-gray-50"><td class="px-2 py-2 font-bold">Settled Loans</td><td class="px-2 py-2 text-right" id="sum-settled-loans-pdf">0.00 LKR</td></tr>
                <tr class="bg-white"><td class="px-2 py-2 font-bold">Due Loans (Pending)</td><td class="px-2 py-2 text-right" id="sum-due-loans-pdf">0.00 LKR</td></tr>
                <tr class="bg-gray-50"><td class="px-2 py-2 font-bold">Salary / Wages</td><td class="px-2 py-2 text-right" id="sum-salary-wages-pdf">0.00 LKR</td></tr>
                <tr class="bg-blue-100 font-bold">
                    <td class="px-2 py-2">Owner's Share (50% Split)</td>
                    <td class="px-2 py-2 text-right text-base text-blue-700" id="sum-profit-loss-pdf">0.00 LKR</td> <!-- Reduced from lg -->
                </tr>
                <!-- Net Profit Row (color logic in JS) -->
                <tr class="bg-gray-200 font-bold">
                    <td class="px-2 py-2">FINAL NET OWNER PROFIT/LOSS</td>
                    <td class="px-2 py-2 text-right text-base" id="sum-net-owner-profit-pdf">0.00 LKR</td> <!-- Reduced from lg -->
                </tr>
            </tbody>
        </table>

        <div class="mt-8 pt-4 border-t border-gray-300">
            <h3 class="text-base font-bold mb-2">Note:</h3> <!-- Reduced from lg -->
            <p id="pdf-note-content" class="text-xs italic"></p> <!-- Reduced from sm -->
        </div>

    </div>
    <!-- End Hidden PDF Template -->

    <!-- Custom Modal Structure (Used for Clear Confirmation) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm m-4">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <p id="modal-message" class="mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>
    <!-- End Custom Modal -->

    <!-- NEW: PDF Summary Modal (Confirm button color changed) -->
    <div id="pdf-summary-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">PDF Download Summary</h2>
            <p class="mb-4">Review the key data below. You can add a custom title for the PDF.</p>
            
            <div class="mb-4">
                <label for="pdf-title-input" class="block text-sm font-medium text-gray-700">Custom PDF Title (Optional)</label>
                <input type="text" id="pdf-title-input" placeholder="e.g., Trip 10 Final Report"
                       class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
            </div>

            <div class="space-y-2 border-t border-b py-4 my-4">
                <div class="flex justify-between text-lg"><span class="font-medium text-gray-600">Total Net Sales:</span><span id="pdf-summary-sales" class="font-bold">0.00 LKR</span></div>
                <div class="flex justify-between text-lg"><span class="font-medium text-gray-600">Total All Expenses:</span><span id="pdf-summary-expenses" class="font-bold text-red-600">0.00 LKR</span></div>
                <div class="flex justify-between text-lg"><span class="font-medium text-gray-600">Owner's Share (50%):</span><span id="pdf-summary-owner-share" class="font-bold text-blue-600">0.00 LKR</span></div>
                <div class="flex justify-between text-xl"><span class="font-bold text-gray-800">Net Owner's Profit/Loss:</span><span id="pdf-summary-net-profit" class="font-extrabold">0.00 LKR</span></div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="report.hidePdfSummaryModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                <button onclick="generatePDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Confirm & Download</button>
            </div>
        </div>
    </div>
    <!-- End PDF Summary Modal -->


    <!-- Firebase Imports and Main Script Logic -->
    <script>
        // --- Global variable for storage ---
        const STORAGE_KEY = 'arrivalReportData';

        // --- Firebase instances ---
        let report; // Declare report instance globally
        
        // --- Custom Modal Logic (replaces alert/confirm) ---
        function showModal(title, message, isConfirm, onConfirm) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;

            const confirmButton = document.getElementById('modal-confirm');
            const cancelButton = document.getElementById('modal-cancel');

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Show/hide confirm button
            confirmButton.style.display = isConfirm ? 'block' : 'none';
            // Change cancel button text if it's not a confirmation
            cancelButton.textContent = isConfirm ? 'Cancel' : 'OK';

            confirmButton.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (onConfirm) onConfirm();
            };

            cancelButton.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
        }

        // --- FIREBASE SETUP (REMOVED) ---

        /**
         * Main class to manage the report data, calculations, and UI updates.
         */
        class ArrivalReport {
            constructor() {
                this.defaultData = {
                    date: new Date().toISOString().substring(0, 10),
                    boardName: '',
                    marketCommissionRate: 5, // New field, default 5%
                    skipperCommissionRate: 5, // New field, default 5%
                    boatLoadedCosts: [],
                    extraExpenses: [],
                    diesel: { liters: 0, pricePerLiter: 277, totalCost: 0 },
                    currentBoatValues: [],
                    boatRepairs: [],
                    loansSettled: [],
                    pendingLoans: [],
                    salaries: [],
                    sales: [],
                    crew: [],
                    note: ''
                };
                // Deep copy the default data to start
                this.data = JSON.parse(JSON.stringify(this.defaultData)); 
                this.isLoaded = false;
                this.init();
            }

            // Initialize UI fields with current data
            init() {
                document.getElementById('arrival-date').value = this.data.date;
                document.getElementById('board-name').value = this.data.boardName;
                document.getElementById('market-commission-rate').value = this.data.marketCommissionRate;
                document.getElementById('skipper-commission-rate').value = this.data.skipperCommissionRate;
                document.getElementById('diesel-liters').value = this.data.diesel.liters;
                document.getElementById('report-note').value = this.data.note;
            }

            // --- Persistence Methods (Load, Save, Clear) ---

            loadReport() {
                try {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        const loadedData = JSON.parse(storedData);
                        // Merge loaded data with defaults to ensure all keys exist
                        this.data = { ...JSON.parse(JSON.stringify(this.defaultData)), ...loadedData };
                        this.init(); // Re-initialize UI fields with loaded data
                        console.log("Report loaded from localStorage.");
                    } else {
                        console.log("No existing report found in localStorage. Starting fresh.");
                    }
                } catch (e) {
                    console.error("Error loading report from localStorage:", e);
                    showModal("Load Error", "Failed to load existing report from local storage.", false);
                }
                this.isLoaded = true;
                this.updateAll(); // Update UI after loading
            }

            saveReport() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
                    console.log("Report saved to localStorage.");
                    const saveMsg = document.getElementById('save-message');
                    saveMsg.textContent = 'Report Saved!';
                    saveMsg.classList.remove('text-red-600'); // Ensure it's blue
                    saveMsg.classList.add('text-blue-600');
                    // Clear message after 3 seconds
                    setTimeout(() => { saveMsg.textContent = ''; }, 3000);
                } catch (e) {
                    console.error("Error saving report to localStorage:", e);
                    const saveMsg = document.getElementById('save-message');
                    saveMsg.textContent = 'Save Failed!';
                    saveMsg.classList.remove('text-blue-600');
                    saveMsg.classList.add('text-red-600');
                    showModal("Save Error", "Could not save data. Local storage might be full or disabled.", false);
                }
            }

            showClearModal() {
                showModal("Clear Data Confirmation", "Are you sure you want to clear ALL report data? This action cannot be undone.", true, () => {
                    this.clearReportData();
                });
            }

            clearReportData() {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                    console.log("Report deleted from localStorage.");
                } catch (e) {
                    console.error("Error deleting report from localStorage:", e);
                    showModal("Error", "Could not clear data from local storage.", false);
                }
                // Reset local data and UI
                this.data = JSON.parse(JSON.stringify(this.defaultData));
                this.init();
                this.updateAll();
                const saveMsg = document.getElementById('save-message');
                saveMsg.textContent = 'Data Cleared!';
                setTimeout(() => { saveMsg.textContent = ''; }, 3000);
            }

            // --- Core Data Manipulation ---

            addEntry(key, descId, amountId) {
                const descInput = document.getElementById(descId);
                const amountInput = document.getElementById(amountId);
                const desc = descInput.value.trim();
                const amount = parseFloat(amountInput.value);

                if (desc && !isNaN(amount) && amount > 0) {
                    this.data[key].push({ desc, amount });
                    descInput.value = '';
                    amountInput.value = '';
                    this.updateAll();
                    this.saveReport(); // Auto-save on addition
                } else if (!desc) {
                    showModal("Input Error", "Please enter a description.", false);
                } else {
                    showModal("Input Error", "Please enter a valid amount greater than 0.", false);
                }
            }

            removeEntry(key, index) {
                this.data[key].splice(index, 1);
                this.updateAll();
                this.saveReport(); // Auto-save on removal
            }

            addSaleEntry() {
                const category = document.getElementById('sale-category').value.trim();
                const weight = parseFloat(document.getElementById('sale-weight').value);
                const priceKg = parseFloat(document.getElementById('sale-price').value);

                if (category && !isNaN(weight) && weight > 0 && !isNaN(priceKg) && priceKg > 0) {
                    this.data.sales.push({ category, weight, priceKg, total: weight * priceKg });
                    document.getElementById('sale-category').value = '';
                    document.getElementById('sale-weight').value = '';
                    document.getElementById('sale-price').value = '';
                    this.updateAll();
                    this.saveReport();
                } else {
                    showModal("Input Error", "Please enter a valid category, weight, and price.", false);
                }
            }

            // Triggered oninput from the sales table
            updateSaleTotal(index) {
                const row = this.data.sales[index];
                const weightInput = document.getElementById(`sale-weight-${index}`);
                const priceInput = document.getElementById(`sale-price-${index}`);

                row.weight = parseFloat(weightInput.value) || 0;
                row.priceKg = parseFloat(priceInput.value) || 0;
                row.total = row.weight * row.priceKg;

                this.updateAll();
                this.saveReport();
            }

            addCrewMember() {
                const nameInput = document.getElementById('crew-name');
                const name = nameInput.value.trim();

                if (name && !this.data.crew.find(c => c.name === name)) {
                    this.data.crew.push({ name, share: 0 });
                    nameInput.value = '';
                    this.updateAll();
                    this.saveReport();
                } else if (!name) {
                    showModal("Input Error", "Please enter a crew member's name.", false);
                } else {
                    showModal("Input Error", "This crew member has already been added.", false);
                }
            }

            removeCrewMember(index) {
                this.data.crew.splice(index, 1);
                this.updateAll();
                this.saveReport();
            }

            updateDate(dateString) {
                this.data.date = dateString;
                this.saveReport();
            }

            updateBoardName(name) {
                this.data.boardName = name;
                this.saveReport();
            }

            updateMarketCommission(rate) {
                this.data.marketCommissionRate = parseFloat(rate) || 0;
                this.updateAll(); // Recalculate everything
                this.saveReport();
            }
            
            updateSkipperCommission(rate) {
                this.data.skipperCommissionRate = parseFloat(rate) || 0;
                this.updateAll(); // Recalculate everything
                this.saveReport();
            }
            
            updateNote(noteValue) {
                this.data.note = noteValue;
                this.saveReport(); // Auto-save on note change
            }

            toggleNetProfit(checkbox) {
                const view = document.getElementById('net-owner-profit-view');
                if (checkbox.checked) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            }
            
            // --- Calculation Logic ---

            sumAmounts(key) {
                return this.data[key].reduce((sum, item) => sum + (item.amount || 0), 0);
            }

            calculateDiesel() {
                const liters = parseFloat(document.getElementById('diesel-liters').value) || 0;
                this.data.diesel.liters = liters;
                this.data.diesel.totalCost = liters * this.data.diesel.pricePerLiter;
                this.updateAll();
                this.saveReport();
            }

            calculateNetSales() {
                return this.data.sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            }

            calculateProfitFlow() {
                const netSales = this.calculateNetSales();
                const marketCommissionRate = (this.data.marketCommissionRate || 0) / 100;
                const skipperCommissionRate = (this.data.skipperCommissionRate || 0) / 100;

                const boatLoadedCostTotal = this.sumAmounts('boatLoadedCosts');
                const extraExpensesTotal = this.sumAmounts('extraExpenses');
                const fuelCost = this.data.diesel.totalCost;
                // Deductible Boat-Loaded Expenses (BLC + EE + Fuel)
                const deductibleExpenses = boatLoadedCostTotal + extraExpensesTotal + fuelCost;

                // 1. Market Commission
                const marketCommission = netSales * marketCommissionRate;
                const balance1 = netSales - marketCommission;

                // 2. Deductible Expenses
                const balance2 = balance1 - deductibleExpenses;

                // 3. Skeeper Commission (only on positive balance)
                const commissionBase = balance2 > 0 ? balance2 : 0;
                const skipperCommission = commissionBase * skipperCommissionRate;
                const finalBalance = commissionBase - skipperCommission;

                // 4. Owner's Profit (50%)
                const ownersProfit = finalBalance > 0 ? finalBalance * 0.5 : 0;

                // 5. Crew Share (50% remaining)
                const crewShareTotal = finalBalance - ownersProfit;
                // Avoid division by zero if no crew is added
                const crewMemberCount = this.data.crew.length > 0 ? this.data.crew.length : 1; 
                const singleCrewShare = crewShareTotal > 0 ? crewShareTotal / crewMemberCount : 0;

                // Update share for each crew member in the data
                this.data.crew = this.data.crew.map(member => ({
                    ...member,
                    share: singleCrewShare
                }));

                // Calculate Net Owner's Profit/Loss
                const cbvTotal = this.sumAmounts('currentBoatValues');
                const brTotal = this.sumAmounts('boatRepairs');
                const lsTotal = this.sumAmounts('loansSettled');
                const salTotal = this.sumAmounts('salaries');
                const netOwnerProfit = ownersProfit - cbvTotal - brTotal - lsTotal - salTotal;

                return {
                    netSales, marketCommission, balance1, deductibleExpenses, balance2,
                    skipperCommission, finalBalance, ownersProfit, crewShareTotal,
                    netOwnerProfit // Return the new value
                };
            }

            // --- Rendering and Formatting ---

            formatLKR(amount) {
                const fixedAmount = (amount || 0).toFixed(2);
                // Add commas for thousands
                return fixedAmount.replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' LKR';
            }

            // Renders a generic list of {desc, amount} items
            renderEntries(key, elementId, isEditable = true) {
                const container = document.getElementById(elementId);
                const entries = this.data[key];
                if (entries.length === 0) {
                    container.innerHTML = `<p class="text-sm text-gray-500 italic">No entries added.</p>`;
                    return;
                }
                container.innerHTML = entries.map((item, index) => `
                    <div class="flex items-center space-x-4 p-2 text-sm border-b last:border-b-0">
                        <span class="flex-grow">${item.desc}</span>
                        <span class="font-medium text-gray-700">${this.formatLKR(item.amount)}</span>
                        ${isEditable ? `<button onclick="report.removeEntry('${key}', ${index})" class="text-red-500 hover:text-red-700 text-xs px-2">Remove</button>` : ''}
                    </div>
                `).join('');
            }

            // Renders the editable sales table
            renderSales() {
                const container = document.getElementById('sales-entries');
                if (this.data.sales.length === 0) {
                    container.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">No sales entries added.</td></tr>`;
                    return;
                }
                container.innerHTML = this.data.sales.map((item, index) => `
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap">${item.category}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <input type="number" id="sale-weight-${index}" value="${item.weight.toFixed(2)}" min="0" oninput="report.updateSaleTotal(${index})" class="w-20 text-right p-1 border rounded-md">
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <input type="number" id="sale-price-${index}" value="${item.priceKg.toFixed(2)}" min="0" oninput="report.updateSaleTotal(${index})" class="w-28 text-right p-1 border rounded-md">
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap font-medium" id="sale-total-${index}">${this.formatLKR(item.total)}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <button onclick="report.removeEntry('sales', ${index})" class="text-red-500 hover:text-red-700 text-xs">Remove</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Renders the crew distribution list
            renderCrewDistribution() {
                const container = document.getElementById('crew-distribution');
                if (this.data.crew.length === 0) {
                    container.innerHTML = `<p class="text-sm text-gray-500 italic">No crew members added. Total crew share will be 0.</p>`;
                    return;
                }
                container.innerHTML = this.data.crew.map((item, index) => `
                    <div class="flex justify-between items-center border-b pb-1">
                        <span class="text-gray-600 flex-grow">${item.name} (1 of ${this.data.crew.length})</span>
                        <!-- Crew share color changed to blue -->
                        <span class="font-bold text-blue-700">${this.formatLKR(item.share)}</span>
                        <button onclick="report.removeCrewMember(${index})" class="ml-4 text-red-500 hover:text-red-700 text-xs px-2">Remove</button>
                    </div>
                `).join('');
            }

            // Main update function: recalculates and re-renders everything
            updateAll() {
                if (!this.isLoaded) return; // Don't update UI until data is loaded
                
                // Render all interactive lists
                this.renderEntries('boatLoadedCosts', 'boat-loaded-cost-entries');
                this.renderEntries('extraExpenses', 'extra-expenses-entries');
                this.renderEntries('currentBoatValues', 'boat-value-entries');
                this.renderEntries('boatRepairs', 'boat-repairs-entries');
                this.renderEntries('loansSettled', 'loans-settled-entries');
                this.renderEntries('pendingLoans', 'pending-loans-entries');
                this.renderEntries('salaries', 'salaries-entries');
                this.renderSales();
                this.renderCrewDistribution(); // Must be rendered before profit calc to get crew count

                // --- Calculate Totals ---
                const blcTotal = this.sumAmounts('boatLoadedCosts');
                const eeTotal = this.sumAmounts('extraExpenses');
                const cbvTotal = this.sumAmounts('currentBoatValues');
                const brTotal = this.sumAmounts('boatRepairs');
                const lsTotal = this.sumAmounts('loansSettled');
                const plTotal = this.sumAmounts('pendingLoans');
                const salTotal = this.sumAmounts('salaries');

                const valueRepairCombinedTotal = cbvTotal + brTotal;
                const loansCombinedTotal = lsTotal + plTotal;

                // --- Update Interactive Totals ---
                document.getElementById('blc-total').textContent = this.formatLKR(blcTotal);
                document.getElementById('ee-total').textContent = this.formatLKR(eeTotal);
                document.getElementById('cbv-total').textContent = this.formatLKR(cbvTotal);
                document.getElementById('br-total').textContent = this.formatLKR(brTotal);
                document.getElementById('ls-total').textContent = this.formatLKR(lsTotal);
                document.getElementById('pl-total').textContent = this.formatLKR(plTotal);
                document.getElementById('sal-total').textContent = this.formatLKR(salTotal);
                document.getElementById('value-repair-combined-total').textContent = this.formatLKR(valueRepairCombinedTotal);
                document.getElementById('loans-combined-total').textContent = this.formatLKR(loansCombinedTotal);
                document.getElementById('diesel-cost-total').textContent = this.formatLKR(this.data.diesel.totalCost);

                // --- Profit Calculation Flow ---
                const profit = this.calculateProfitFlow(); // This recalculates crew shares internally
                document.getElementById('net-sales-total').textContent = this.formatLKR(profit.netSales);

                document.getElementById('p-net-sales').textContent = this.formatLKR(profit.netSales);
                document.getElementById('p-market-commission').textContent = `-${this.formatLKR(profit.marketCommission)}`;
                document.getElementById('p-balance-1').textContent = this.formatLKR(profit.balance1);
                document.getElementById('p-deductible-expenses').textContent = `-${this.formatLKR(profit.deductibleExpenses)}`;
                document.getElementById('p-balance-2').textContent = this.formatLKR(profit.balance2);
                document.getElementById('p-skipper-commission').textContent = `-${this.formatLKR(profit.skipperCommission)}`;
                document.getElementById('p-final-balance').textContent = this.formatLKR(profit.finalBalance);
                document.getElementById('p-owner-profit').textContent = this.formatLKR(profit.ownersProfit);
                document.getElementById('p-crew-total').textContent = this.formatLKR(profit.crewShareTotal);

                // Update Net Owner Profit display (color changed to blue for profit)
                const netProfitDisplay = document.getElementById('net-owner-profit-display');
                netProfitDisplay.textContent = this.formatLKR(profit.netOwnerProfit);
                if (profit.netOwnerProfit >= 0) {
                    netProfitDisplay.classList.remove('text-red-600');
                    netProfitDisplay.classList.add('text-blue-600');
                } else {
                    netProfitDisplay.classList.remove('text-blue-600');
                    netProfitDisplay.classList.add('text-red-600');
                }

                // Re-render crew distribution *after* profit calc to show correct shares
                this.renderCrewDistribution();
            }

            // --- PDF Modal Logic ---
            showPdfSummaryModal() {
                const profit = this.calculateProfitFlow();
                const blcTotal = this.sumAmounts('boatLoadedCosts');
                const eeTotal = this.sumAmounts('extraExpenses');
                const cbvTotal = this.sumAmounts('currentBoatValues');
                const brTotal = this.sumAmounts('boatRepairs');
                const lsTotal = this.sumAmounts('loansSettled');
                const salTotal = this.sumAmounts('salaries');
                const fuelCost = this.data.diesel.totalCost;

                const totalExpenses = blcTotal + eeTotal + fuelCost + cbvTotal + brTotal + lsTotal + salTotal;
                
                document.getElementById('pdf-summary-sales').textContent = this.formatLKR(profit.netSales);
                document.getElementById('pdf-summary-expenses').textContent = `-${this.formatLKR(totalExpenses)}`;
                document.getElementById('pdf-summary-owner-share').textContent = this.formatLKR(profit.ownersProfit);
                document.getElementById('pdf-summary-net-profit').textContent = this.formatLKR(profit.netOwnerProfit);

                // Style Net Profit in modal (color changed to blue for profit)
                const netProfitModalDisplay = document.getElementById('pdf-summary-net-profit');
                if (profit.netOwnerProfit >= 0) {
                    netProfitModalDisplay.classList.remove('text-red-600');
                    netProfitModalDisplay.classList.add('text-blue-600');
                } else {
                    netProfitModalDisplay.classList.remove('text-blue-600');
                    netProfitModalDisplay.classList.add('text-red-600');
                }

                document.getElementById('pdf-summary-modal').classList.remove('hidden');
                document.getElementById('pdf-summary-modal').classList.add('flex');
            }

            hidePdfSummaryModal() {
                document.getElementById('pdf-summary-modal').classList.add('hidden');
                document.getElementById('pdf-summary-modal').classList.remove('flex');
            }
        }

        // --- PDF Generation Function ---

        // Renders a simple {desc, amount} list for the PDF
        // *** UPDATED TO RENDER TABLE ROWS (TR) ***
        function renderPdfSection(key, elementId) {
            const container = document.getElementById(elementId);
            const entries = report.data[key];
            if (entries.length === 0) {
                container.innerHTML = `<tr><td colspan="2" class="py-2 px-1 italic text-gray-500">No entries</td></tr>`;
                return;
            }
            container.innerHTML = entries.map((item, index) => `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="py-2 px-1">${item.desc}</td>
                    <td class="text-right py-2 px-1">${report.formatLKR(item.amount)}</td>
                </tr>
            `).join('');
        }

        // Fills the hidden #pdf-template with all current data
        // *** UPDATED TO POPULATE TABLE ROWS (TR) ***
        function populatePdfTemplate(profit, blcTotal, eeTotal, cbvTotal, brTotal, lsTotal, plTotal, salTotal) {
            const customTitle = document.getElementById('pdf-title-input').value.trim();
            
            // Header
            document.getElementById('pdf-report-title').textContent = customTitle || 'ARRIVAL REPORT';
            document.getElementById('pdf-board-date').textContent = `Board: ${report.data.boardName || 'N/A'} | Date: ${report.data.date}`;
            
            // Sales Breakdown
            document.getElementById('pdf-sales-breakdown').innerHTML = report.data.sales.map((s, index) => `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="py-2 px-1">${s.category} (${s.weight.toFixed(2)} Kg @ ${s.priceKg.toFixed(2)}/Kg)</td>
                    <td class="text-right py-2 px-1">${report.formatLKR(s.total)}</td>
                </tr>
            `).join('');
            if(report.data.sales.length === 0) {
                 document.getElementById('pdf-sales-breakdown').innerHTML = `<tr><td colspan="2" class="py-2 px-1 italic text-gray-500">No sales entries</td></tr>`;
            }
            document.getElementById('pdf-net-sales-total').textContent = report.formatLKR(profit.netSales);

            // Expenses Breakdown
            renderPdfSection('boatLoadedCosts', 'pdf-blc-breakdown');
            renderPdfSection('extraExpenses', 'pdf-ee-breakdown');
            
            document.getElementById('pdf-diesel-breakdown').innerHTML = `
                <tr class="bg-white">
                    <td class="py-2 px-1">Fuel Consumption (${report.data.diesel.liters.toFixed(2)} Liters)</td>
                    <td class="text-right py-2 px-1">${report.formatLKR(report.data.diesel.totalCost)}</td>
                </tr>
            `;
            document.getElementById('pdf-total-deductible-expenses').textContent = report.formatLKR(profit.deductibleExpenses);

            // Other Expenses (Salaries)
            renderPdfSection('salaries', 'pdf-salaries-breakdown');
            document.getElementById('pdf-salaries-total').textContent = report.formatLKR(salTotal);

            // Loans & Capital
            renderPdfSection('loansSettled', 'pdf-loans-settled-breakdown');
            renderPdfSection('pendingLoans', 'pdf-pending-loans-breakdown');
            
            // New: Boat Value & Repairs
            renderPdfSection('currentBoatValues', 'pdf-boat-value-breakdown');
            renderPdfSection('boatRepairs', 'pdf-repairs-breakdown');
            document.getElementById('pdf-value-repair-total').textContent = report.formatLKR(cbvTotal + brTotal);


            // Profit Flow
            document.getElementById('s-net-sales-pdf').textContent = report.formatLKR(profit.netSales);
            document.getElementById('s-market-comm-rate-pdf').textContent = report.data.marketCommissionRate;
            document.getElementById('s-market-commission-pdf').textContent = `-${report.formatLKR(profit.marketCommission)}`;
            document.getElementById('s-balance1-pdf').textContent = report.formatLKR(profit.balance1);
            document.getElementById('s-deductible-expenses-pdf').textContent = `-${report.formatLKR(profit.deductibleExpenses)}`;
            document.getElementById('s-balance2-pdf').textContent = report.formatLKR(profit.balance2);
            document.getElementById('s-skipper-comm-rate-pdf').textContent = report.data.skipperCommissionRate;
            document.getElementById('s-skipper-commission-pdf').textContent = `-${report.formatLKR(profit.skipperCommission)}`;
            document.getElementById('s-final-balance-pdf').textContent = report.formatLKR(profit.finalBalance);
            document.getElementById('s-owner-profit-pdf').textContent = report.formatLKR(profit.ownersProfit);
            
            document.getElementById('pdf-crew-breakdown').innerHTML = report.data.crew.map((c, index) => `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="py-2 px-1 text-xs">- ${c.name}</td> <!-- Reduced from sm -->
                    <td class="text-right py-2 px-1 text-xs">${report.formatLKR(c.share)}</td> <!-- Reduced from sm -->
                </tr>
            `).join('');
             if(report.data.crew.length === 0) {
                 document.getElementById('pdf-crew-breakdown').innerHTML = `<tr><td colspan="2" class="py-2 px-1 italic text-gray-500">No crew members</td></tr>`;
            }
            document.getElementById('s-crew-total-pdf').textContent = report.formatLKR(profit.crewShareTotal);

            // Final Summary Table
            document.getElementById('sum-net-sales-pdf').textContent = report.formatLKR(profit.netSales);
            document.getElementById('sum-departure-expenditure-pdf').textContent = report.formatLKR(blcTotal + eeTotal);
            document.getElementById('sum-fuel-consumption-pdf').textContent = report.formatLKR(report.data.diesel.totalCost);
            document.getElementById('sum-current-boat-value-pdf').textContent = report.formatLKR(cbvTotal);
            document.getElementById('sum-boat-repairs-pdf').textContent = report.formatLKR(brTotal);
            document.getElementById('sum-settled-loans-pdf').textContent = report.formatLKR(lsTotal);
            document.getElementById('sum-due-loans-pdf').textContent = report.formatLKR(plTotal);
            document.getElementById('sum-salary-wages-pdf').textContent = report.formatLKR(salTotal);
            document.getElementById('sum-profit-loss-pdf').textContent = report.formatLKR(profit.ownersProfit);
            
            // Net Owner Profit (color changed to blue for profit)
            const netOwnerProfitPDF = document.getElementById('sum-net-owner-profit-pdf');
            netOwnerProfitPDF.textContent = report.formatLKR(profit.netOwnerProfit);
             if (profit.netOwnerProfit >= 0) {
                netOwnerProfitPDF.classList.remove('text-red-600');
                netOwnerProfitPDF.classList.add('text-blue-600');
            } else {
                netOwnerProfitPDF.classList.remove('text-blue-600');
                netOwnerProfitPDF.classList.add('text-red-600');
            }


            // Note
            document.getElementById('pdf-note-content').textContent = report.data.note || 'No notes recorded.';
        }

        // Main function to trigger PDF generation
        function generatePDF() {
            // First, hide the modal
            report.hidePdfSummaryModal();

            const element = document.getElementById('pdf-template');
            const date = report.data.date || 'report';
            const customTitle = document.getElementById('pdf-title-input').value.trim();
            const fileName = `${customTitle.replace(/ /g, '_') || report.data.boardName.replace(/ /g, '_') || 'Arrival_Report'}_${date}.pdf`;

            // Recalculate everything and populate the hidden template before capture
            const blcTotal = report.sumAmounts('boatLoadedCosts');
            const eeTotal = report.sumAmounts('extraExpenses');
            const cbvTotal = report.sumAmounts('currentBoatValues');
            const brTotal = report.sumAmounts('boatRepairs');
            const lsTotal = report.sumAmounts('loansSettled');
            const plTotal = report.sumAmounts('pendingLoans');
            const salTotal = report.sumAmounts('salaries');
            // This calculation is vital as it updates crew shares
            const profit = report.calculateProfitFlow(); 

            // Populate the template with the latest data
            populatePdfTemplate(profit, blcTotal, eeTotal, cbvTotal, brTotal, lsTotal, plTotal, salTotal);

            element.style.display = 'block'; // Temporarily show the template for capture

            const options = { 
                scale: 2, // Higher scale for better quality
                useCORS: true, 
                logging: false, 
                backgroundColor: '#ffffff' 
            };
            const { jsPDF } = window.jspdf; // Get jsPDF from the global scope

            html2canvas(element, options).then(canvas => {
                element.style.display = 'none'; // Hide template immediately after capture

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                const pdf = new jsPDF('p', 'mm', 'a4'); // Portrait, mm, A4
                let position = 0;

                // Add the first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add new pages if the content is longer than one page
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(fileName);
            }).catch(error => {
                element.style.display = 'none';
                console.error('Error generating PDF:', error);
                showModal("PDF Generation Failed", "There was an error generating the PDF. Please check the console for details.", false);
            });
        }

        // --- GLOBAL INITIALIZATION ---
        
        // Initialize the report system
        report = new ArrivalReport();
        
        // Expose functions to the global window scope so HTML onclick attributes can find them
        window.report = report;
        window.showModal = showModal;
        window.generatePDF = generatePDF;

        // Start the app by loading data
        report.loadReport();
    </script>
</body>

</html>
